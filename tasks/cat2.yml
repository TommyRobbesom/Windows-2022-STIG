---

- name: "MEDIUM | WN22-00-000010 | AUDIT |  Windows Server 2022 users with Administrative privileges must have separate accounts for administrative duties and normal operational tasks."
  block:
      - name: "MEDIUM | WN22-00-000010 | AUDIT |  Windows Server 2022 users with Administrative privileges must have separate accounts for administrative duties and normal operational tasks. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task.  Windows Server 2022 users with Administrative privileges must have separate accounts for administrative duties and normal operational tasks."

      - name: "MEDIUM | WN22-00-000010 | AUDIT |  Windows Server 2022 users with Administrative privileges must have separate accounts for administrative duties and normal operational tasks. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000010'
  when:
      - wn22_00_000010
  tags:
      - WN22-00-000010
      - V-254238
      - SRG-OS-000480-GPOS-00227
      - SV-254238r848530_rule
      - CCI-000366
      - CAT2

# enumerating on DC is different than standalone
- name: "MEDIUM | WN22-00-000020 | AUDIT | Windows Server 2022 passwords for the built-in Administrator account must be changed at least every {{ wn22stig_pass_age }} days."
  block:
      - name: "MEDIUM | WN22-00-000020 | AUDIT - DOMAIN CONTROLLER | Windows Server 2022 passwords for the built-in Administrator account must be changed at least every {{ wn22stig_pass_age }} days."
        ansible.windows.win_shell: "Get-ADUser -Filter * -Property PasswordLastSet | Where SID -like S-1-5-21-*-500 | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn22stig_pass_age }}))} | Select Name,PasswordLastSet"
        # win_shell: "Get-ADUser krbtgt -Property PasswordLastSet | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn22stig_krbtgt_pass_age }}))} | Select-Object -ExpandProperty PasswordLastSet"
        changed_when: false
        check_mode: false
        register: wn22_00_000020_audit_dc
        when: "'controller' in ansible_windows_domain_role"

      - name: "MEDIUM | WN22-00-000020 | AUDIT - DOMAIN CONTROLLER | Windows Server 2022 passwords for the built-in Administrator account must be changed at least every {{ wn22stig_pass_age }} days."
        ansible.builtin.debug:
            msg:
                - "The following account appears to be the default admin account and the password does not meet the control specific age of {{ wn22stig_pass_age }}"
                - "{{ wn9_00_000020_audit_dc.stdout.split('\n') }}"
        when:
            - not wn22_00_000020_audit_dc is skipped
            - wn22_00_000020_audit_dc.stdout != ""

      - name: "MEDIUM | WN22-00-000020 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2022 passwords for the built-in Administrator account must be changed at least every {{ wn22stig_pass_age }} days."
        ansible.windows.win_shell: "Get-Localuser -Name * | Select * | Where SID -like S-1-5-21-*-500 | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn22stig_pass_age }}))} | Select Name,PasswordLastSet"
        changed_when: false
        check_mode: false
        register: wn22_00_000020_audit_dm_sa

      - name: "MEDIUM | WN22-00-000020 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2022 passwords for the built-in Administrator account must be changed at least every {{ wn22stig_pass_age }} days."
        ansible.builtin.debug:
            msg:
                - "The following account appears to be the default admin account and the password does not meet the control specific age of {{ wn22stig_pass_age }}"
                - "{{ wn22_00_000020_audit_dm_sa.stdout.split('\n') }}"
        when:
            - wn22_00_000020_audit_dm_sa is defined
            - wn22_00_000020_audit_dm_sa.stdout != ""

      - name: Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000020'
        when:
            - not wn22_00_000020_audit_dc is skipped
            - wn22_00_000020_audit_dc.stdout != "" or
            - wn22_00_000020_audit_dm_sa is defined
            - wn22_00_000020_audit_dm_sa.stdout != ""
  when:
      - wn22_00_000020
  tags:
      - WN22-00-000020
      - V-254239
      - CCI-000199
      - SV-254239r915618_rule
      - SRG-OS-000076-GPOS-00044
      - NeedToTestDomainController
      - audit
      - CAT2

- name: "MEDIUM | WN22-00-000040 | AUDIT | Windows Server 2022 members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks."
  block:
      - name: "MEDIUM | WN22-00-000040 | AUDIT - STAND-ALONE AND MEMBER SERVERS | Windows Server 2022 members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks."
        ansible.windows.win_shell: Get-LocalGroupMember -Name 'Backup Operators'
        changed_when: false
        check_mode: false
        register: wn22_00_000040_audit

      - name: "MEDIUM | WN22-00-000040 | AUDIT - STAND-ALONE AND MEMBER SERVERS | Windows Server 2022 members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks."
        ansible.builtin.debug:
            msg:
                - The accounts listed are members of the Backup Operators group
                - "{{ wn22_00_000040_audit.stdout.split('\n') }}"
        when:
            - not wn22_00_000040_audit is skipped
            - wn22_00_000040_audit.stdout != ""
        changed_when: false

      - name: "MEDIUM | WN22-00-000040 | AUDIT - STAND-ALONE AND MEMBER SERVERS | Windows Server 2022 members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000040'
        when:
            - not wn22_00_000040_audit is skipped
            - wn22_00_000040_audit.stdout != ""
  when:
      - wn22_00_000040
      - "'controller' not in ansible_windows_domain_role"
  tags:
      - WN22-00-000040
      - V-254241
      - SRG-OS-000480-GPOS-00227
      - SV-254241r848539_rule
      - CCI-000366
      - audit
      - CAT2

- name: "MEDIUM | WN22-00-000050 | AUDIT | Windows Server 2022 manually managed application account passwords must be at least 15 characters in length."
  block:
      - name: "MEDIUM | WN22-00-000050 | AUDIT | Windows Server 2022 manually managed application account passwords must be at least 15 characters in length. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 manually managed application account passwords must be at least 15 characters in length."

      - name: "MEDIUM | WN22-00-000050 | AUDIT | Windows Server 2022 manually managed application account passwords must be at least 15 characters in length. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000050'
  when:
      - wn22_00_000050
  tags:
      - WN22-00-000050
      - V-254242
      - SRG-OS-000078-GPOS-00046
      - SV-254242r848542_rule
      - CCI-000205
      - CAT2

- name: "MEDIUM | WN22-00-000060 | AUDIT | Windows Server 2022 manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization."
  block:
      - name: "MEDIUM | WN22-00-000060 | AUDIT | Windows Server 2022 manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization."

      - name: "MEDIUM | WN22-00-000060 | AUDIT | Windows Server 2022 manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000060'
  when:
      - wn22_00_000060
  tags:
      - WN22-00-000060
      - V-254243
      - SRG-OS-000480-GPOS-00227
      - SV-254243r848545_rule
      - CCI-000366
      - CAT2
      # how to make this list?

- name: "MEDIUM | WN22-00-000070 | AUDIT | Windows Server 2022 shared user accounts must not be permitted."
  block:
      - name: "MEDIUM | WN22-00-000070  | Windows Server 2022 shared user accounts must not be permitted. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 shared user accounts must not be permitted."

      - name: "MEDIUM | WN22-00-000070 | AUDIT | Windows Server 2022 shared user accounts must not be permitted. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000070'
  when:
      - wn22_00_000070
  tags:
      - WN22-00-000070
      - V-254244
      - SRG-OS-000104-GPOS-00051
      - SV-254244r848548_rule
      - CCI-000764
      - CAT2

- name: "MEDIUM | WN22-00-000080 | AUDIT | Windows Server 2022 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs."
  block:
      - name: "MEDIUM | WN22-00-000080 | AUDIT | Windows Server 2022 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs."

      - name: "MEDIUM | WN22-00-000080 | AUDIT | Windows Server 2022 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000080'
  when:
      - wn22_00_000080
  tags:
      - WN22-00-000080
      - V-254245
      - SRG-OS-000370-GPOS-00155
      - SV-254245r890536_rule
      - CCI-001774
      - CAT2
      # Get-AppLockerPolicy -Effective

# Current hardware and virtual environments may not support virtualization-based security features, including Credential Guard, due to specific supporting
# requirements including a TPM, UEFI with Secure Boot, and the capability to run the Hyper-V feature within a virtual machine.
- name: "MEDIUM | WN22-00-000090 | AUDIT | Windows Server 2022 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use."
  block:
      - name: "MEDIUM | WN22-00-000090 | AUDIT | Windows Server 2022 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use."

      - name: "MEDIUM | WN22-00-000090 | AUDIT | Windows Server 2022 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000090'
  when:
      - wn22_00_000090
  tags:
      - WN22-00-000090
      - V-254246
      - SRG-OS-000480-GPOS-00227
      - SV-254246r848554_rule
      - CCI-000366
      - CAT2
      # wmic /namespace:\\root\cimv2\security\microsofttpm path win32_tpm get *
      # if not enabled see "No Instance(s) Available." ?

- name: "MEDIUM | WN22-00-000100 | AUDIT | Windows Server 2022 must be maintained at a supported servicing level."
  block:
      - name: "MEDIUM | WN22-00-000100 | AUDIT | Windows Server 2022 must be maintained at a supported servicing level. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must be maintained at a supported servicing level."

      - name: "MEDIUM | WN22-00-000100 | AUDIT | Windows Server 2022 must be maintained at a supported servicing level. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000100'
  when:
      - wn22_00_000100
  tags:
      - WN22-00-000100
      - V-254247
      - SRG-OS-000480-GPOS-00227
      - SV-254247r848557_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-00-000110 | AUDIT | Windows Server 2022 must use an antivirus program."
  block:
      - name: "MEDIUM | WN22-00-000110 | AUDIT | Windows Server 2022 must use an antivirus program. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must use an antivirus program."

      - name: "MEDIUM | WN22-00-000110 | AUDIT | Windows Server 2022 must use an antivirus program. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000110'
  when:
      - wn22_00_000110
  tags:
      - WN22-00-000110
      - V-254248
      - SRG-OS-000480-GPOS-00227
      - SV-254248r848560_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-00-000120 | AUDIT | Windows Server 2022 must have a host-based intrusion detection or prevention system."
  block:
      - name: "MEDIUM | WN22-00-000120 | AUDIT | Windows Server 2022 must have a host-based intrusion detection or prevention system. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have a host-based intrusion detection or prevention system."

      - name: "MEDIUM | WN22-00-000120 | AUDIT | Windows Server 2022 must have a host-based intrusion detection or prevention system. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000120'
  when:
      - wn22_00_000120
  tags:
      - WN22-00-000120
      - V-254249
      - SRG-OS-000480-GPOS-00227
      - SV-254249r848563_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-00-000140 | AUDIT | Windows Server 2022 permissions for the system drive root directory usually C:\ must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN22-00-000140 | AUDIT | Windows Server 2022 permissions for the system drive root directory usually C:\ must conform to minimum requirements. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 permissions for the system drive root directory usually C:\ must conform to minimum requirements."

      - name: "MEDIUM | WN22-00-000140 | AUDIT | Windows Server 2022 permissions for the system drive root directory usually C:\ must conform to minimum requirements. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000140'
  when:
      - wn22_00_000140
  tags:
      - WN22-00-000140
      - V-254251
      - SRG-OS-000312-GPOS-00122
      - SV-254251r848569_rule
      - CCI-002165
      - CAT2

- name: "MEDIUM | WN22-00-000150 | AUDIT | Windows Server 2022 permissions for program file directories must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN22-00-000150 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Obtain icacls for Program Files."
        ansible.windows.win_shell: icacls "c:\Program Files"
        changed_when: false
        failed_when: false
        register: wn22_00_000150_program_files_audit

      - name: "MEDIUM | WN22-00-000150 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Manual Audit icacls for Program Files."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task to audit. Windows Server 2022 icacls program needs to meet"
                - "the STIG requirements. Please check the report below and compare the the STIG requirements."
                - "{{ wn22_00_000150_program_files_audit.stdout_lines }}"

      - name: "MEDIUM | WN22-00-000150 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Obtain icacls for Program Files x86"
        ansible.windows.win_shell: icacls "c:\Program Files (x86)"
        changed_when: false
        failed_when: false
        register: wn22_00_000150_program_files_86_audit

      - name: "MEDIUM | WN22-00-000150 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Manual Audit icacls for Program Files x86."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task to audit. Windows Server 2022 icacls program files x86 needs to meet"
                - "the STIG requirements. Please check the report below and compare the the STIG requirements."
                - "{{ wn22_00_000150_program_files_86_audit.stdout_lines }}"
        vars:
            warn_control_id: 'WN22-00-000150'
  when:
      - wn22_00_000150
  tags:
      - WN22-00-000150
      - V-254252
      - SRG-OS-000312-GPOS-00122
      - SV-254252r848572_rule
      - CCI-002165
      - CAT2

- name: "MEDIUM | WN22-00-000160 | AUDIT | Windows Server 2022 permissions for the Windows installation directory must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN22-00-000160 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements. | Obtain icacls for Windows Directory."
        ansible.windows.win_shell: icacls "c:\windows"
        changed_when: false
        failed_when: false
        register: wn16_00_000160_windows_dir_audit

      - name: "MEDIUM | WN22-00-000160 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task to audit. Windows Server 2016 permissions for the Windows installation directory needs to meet"
                - "the STIG requirements. Please check the report below and compare the the STIG requirements."
                - "{{ wn16_00_000160_windows_dir_audit.stdout_lines }}"

      - name: "MEDIUM | WN22-00-000160 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000160'
  when:
      - wn22_00_000160
  tags:
      - WN22-00-000160
      - V-254253
      - SRG-OS-000312-GPOS-00122
      - SV-254253r848575_rule
      - CCI-002165
      - CAT2

- name: "MEDIUM | WN22-00-000170 | AUDIT | Windows Server 2022 default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained."
  block:
      - name: "MEDIUM | WN22-00-000170 | AUDIT | Windows Server 2022 default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained."

      - name: "MEDIUM | WN22-00-000170 | AUDIT | Windows Server 2022 default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000170'
  when:
      - wn22_00_000170
  tags:
      - WN22-00-000170
      - V-254254
      - SRG-OS-000324-GPOS-00125
      - SV-254254r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-00-000190 | AUDIT | Windows Server 2022 outdated or unused accounts must be removed from the system or disabled."
  block:
      - name: "MEDIUM | WN22-00-000190 | AUDIT | Windows Server 2022 outdated or unused accounts must be removed from the system or disabled. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 outdated or unused accounts must be removed from the system or disabled."

      - name: "MEDIUM | WN22-00-000190 | AUDIT | Windows Server 2022 outdated or unused accounts must be removed from the system or disabled. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000190'
  when:
      - wn22_00_000190
  tags:
      - WN22-00-000190
      - V-254256
      - SRG-OS-000118-GPOS-00060
      - SV-254256r848584_rule
      - CCI-000795
      - CAT2

- name: "MEDIUM | WN22-00-000200 | AUDIT | Windows Server 2022 accounts must require passwords."
  block:
      - name: "MEDIUM | WN22-00-000200 | AUDIT - DOMAIN CONTROLLER | Windows Server 2022 accounts must require passwords."
        ansible.windows.win_shell: Get-Aduser -Filter "(Passwordnotrequired -eq 'True') -and (Enabled -eq 'True')" | Select Name,Passwordnotrequired,Enabled
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_00_000200_audit_dc
        when: ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN22-00-000200 | AUDIT - DOMAIN CONTROLLER | Windows Server 2022 accounts must require passwords."
        ansible.builtin.debug:
            msg:
                - The accounts listed are do not require a password and are currently enabled
                - "{{ wn22_00_000200_audit_dc.stdout.split('\n') }}"
        when:
            - not wn22_00_000200_audit_dc is skipped
            - wn22_00_000200_audit_dc.stdout != ""

      - name: "MEDIUM | WN22-00-000200 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2022 accounts must require passwords."
        ansible.windows.win_shell: Get-LocalUser | Where-Object {($_.PasswordRequired -ne 'True' -and $_.Enabled -eq 'True')} | Select Name,PasswordRequired,Enabled
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_00_000200_audit_dm_sa
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN22-00-000200 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2022 accounts must require passwords."
        ansible.builtin.debug:
            msg:
                - The accounts listed are do not require a password and are currently enabled
                - "{{ wn22_00_000200_audit_dm_sa.stdout.split('\n') }}"
        when:
            - not wn22_00_000200_audit_dm_sa is skipped
            - wn22_00_000200_audit_dm_sa.stdout != ""

      - name: Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000200'
        when:
            - not wn22_00_000200_audit_dc is skipped
            - wn22_00_000200_audit_dc.stdout != "" or
            - not wn22_00_000200_audit_dm_sa is skipped
            - wn22_00_000200_audit_dm_sa.stdout != ""
  when:
      - wn22_00_000200
  tags:
      - WN22-00-000200
      - V-254257
      - SRG-OS-000104-GPOS-00051
      - SV-254257r848587_rule
      - CCI-000764
      - audit
      - CAT2

- name: "MEDIUM | WN22-00-000210 | AUDIT | Windows Server 2022 passwords must be configured to expire."
  block:
      - name: "MEDIUM | WN22-00-000210 | AUDIT | Windows Server 2022 passwords must be configured to expire."
        ansible.windows.win_shell: |
          Get-CimInstance -Class Win32_Useraccount -Filter "PasswordExpires=False and LocalAccount=True" |
          Where-Object -FilterScript {$_.PasswordExpires -EQ $False -AND $_.Disabled -EQ $False} |
          Format-Table -Property Name,PasswordExpires,Disabled,LocalAccount
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_00_000210_audit

      - name: "MEDIUM | WN22-00-000210 | AUDIT | Windows Server 2022 passwords must be configured to expire.| Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 passwords must be configured to expire."

      - name: "MEDIUM | WN22-00-000210 | AUDIT | Windows Server 2022 passwords must be configured to expire.| import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000210'
  when:
      - wn22_00_000210
  tags:
      - WN22-00-000210
      - V-254258
      - SRG-OS-000076-GPOS-00044
      - SV-254258r848590_rule
      - CAT2
      - CCI-000199

- name: "MEDIUM | WN22-00-000220 | AUDIT | Windows Server 2022 system files must be monitored for unauthorized changes."
  block:
      - name: "MEDIUM | WN22-00-000220 | AUDIT | Windows Server 2022 system files must be monitored for unauthorized changes. | Message out"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 system files must be monitored for unauthorized changes."

      - name: "MEDIUM | WN22-00-000220 | AUDIT | Windows Server 2022 system files must be monitored for unauthorized changes. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000220'
  when:
      - wn22_00_000220
  tags:
      - WN22-00-000220
      - V-254259
      - SRG-OS-000363-GPOS-00150
      - SV-254259r890538_rule
      - CCI-001744
      - CAT2
      # Some third party software to monitor files

- name: "MEDIUM | WN22-00-000230 | AUDIT | Windows Server 2022 non-system-created file shares on a system must limit access to groups that require it."
  block:
      - name: "MEDIUM | WN22-00-000230 | AUDIT | Windows Server 2022 non-system-created file shares on a system must limit access to groups that require it."
        ansible.windows.win_shell: Get-SmbShare | Where-Object -FilterScript {$_.Special -EQ $False}
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_00_000230_audit

      - name: "MEDIUM | WN22-00-000230 | AUDIT | Windows Server 2022 non-system-created file shares on a system must limit access to groups that require it."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 non-system-created file shares on a system must limit access to groups that require it."

      - name: "MEDIUM | WN22-00-000230 | AUDIT | Windows Server 2022 non-system-created file shares on a system must limit access to groups that require it. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000230'
  when:
      - wn22_00_000230
  tags:
      - WN22-00-000230
      - V-254260
      - SRG-OS-000138-GPOS-00069
      - SV-254260r848596_rule
      - CCI-001090
      - CAT2

# https://stackoverflow.com/questions/31049454/how-to-retrieve-recursively-any-files-with-a-specific-extensions-in-powershell/31049571
- name: "MEDIUM | WN22-00-000240 | AUDIT | Windows Server 2022 must have software certificate installation files removed."
  block:
      - name: "MEDIUM | WN22-00-000240 | AUDIT | Windows Server 2022 must have software certificate installation files removed."
        ansible.windows.win_find:
            paths: c:\
            patterns: ['*.p12', '*.pfx']
            hidden: true
            recurse: true
            follow: true
        check_mode: false
        register: wn22_00_000240_audit
        when: long_running

      - name: "MEDIUM | WN22-00-000240 | AUDIT | Windows Server 2022 must have software certificate installation files removed."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have software certificate installation files removed."

      - name: "MEDIUM | WN22-00-000240 | AUDIT | Windows Server 2022 must have software certificate installation files removed. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000240'
  when:
      - wn22_00_000240
  tags:
      - WN22-00-000240
      - V-254261
      - SRG-OS-000480-GPOS-00227
      - SV-254261r848599_rule
      - CCI-000366
      - CAT2
      # do we need async; its very long running to search filesystems
      # get an array of drive letters to search?

- name: "MEDIUM | WN22-00-000250 | AUDIT | Windows Server 2022 systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."
  block:
      - name: "MEDIUM | WN22-00-000250 | AUDIT | Windows Server 2022 systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."

      - name: "MEDIUM | WN22-00-000250 | AUDIT | Windows Server 2022 systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000250'
  when:
      - wn22_00_000250
  tags:
      - WN22-00-000250
      - V-254262
      - SRG-OS-000185-GPOS-00079
      - SV-254262r848602_rule
      - CCI-001199
      - CCI-002475
      - CCI-002476
      - CAT2

- name: "MEDIUM | WN22-00-000260 | AUDIT | Windows Server 2022 must implement protection methods such as TLS, encrypted VPNs, or IPsec if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process."
  block:
      - name: "MEDIUM | WN22-00-000260 | AUDIT | Windows Server 2022 must implement protection methods such as TLS, encrypted VPNs, or IPsec if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must implement protection methods such as TLS, encrypted VPNs, or IPsec if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process."

      - name: "MEDIUM | WN22-00-000260 | AUDIT | Windows Server 2022 must implement protection methods such as TLS, encrypted VPNs, or IPsec if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000260'
  when:
      - wn22_00_000260
  tags:
      - WN22-00-000260
      - V-254263
      - SRG-OS-000425-GPOS-00189
      - SV-254263r848605_rule
      - CCI-002420
      - CCI-002422
      - CAT2

- name: "MEDIUM | WN22-00-000270 | AUDIT | Windows Server 2022 must have the roles and features required by the system documented."
  block:
      - name: "MEDIUM | WN22-00-000270 | AUDIT | Windows Server 2022 bust have the roles and features required by the system documented."
        ansible.windows.win_shell: Get-WindowsFeature | Where-Object -FilterScript {$_.Installed -EQ $True}
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_00_000270_audit

      - name: "MEDIUM | WN22-00-000270 | AUDIT | Windows Server 2022 must have the roles and features required by the system documented."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have the roles and features required by the system documented."

      - name: "MEDIUM | WN22-00-000270 | AUDIT | Windows Server 2022 must have the roles and features required by the system documented. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000270'
  when:
      - wn22_00_000270
  tags:
      - WN22-00-000270
      - V-254264
      - SRG-OS-000095-GPOS-00049
      - SV-254264r848608_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000280 | AUDIT | Windows Server 2022 must have a host-based firewall installed and enabled."
  block:
      - name: "MEDIUM | WN22-00-000280 | AUDIT | Windows Server 2022 must have a host-based firewall installed and enabled."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have a host-based firewall installed and enabled."

      - name: "MEDIUM | WN22-00-000280 | AUDIT | Windows Server 2022 must have a host-based firewall installed and enabled. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000280'
  when:
      - wn22_00_000280
  tags:
      - WN22-00-000280
      - V-254265
      - SRG-OS-000480-GPOS-00227
      - SV-254265r848611_rule
      - CCI-000366
      - CCI-002080
      - CAT2

- name: "MEDIUM | WN22-00-000290 | AUDIT | Windows Server 2022 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP)."
  block:
      - name: "MEDIUM | WN22-00-000290 | AUDIT | Windows Server 2022 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP)."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP)."

      - name: "MEDIUM | WN22-00-000290 | AUDIT | Windows Server 2022 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP). | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000290'
  when:
      - wn22_00_000290
  tags:
      - WN22-00-000290
      - V-254266
      - SRG-OS-000191-GPOS-00080
      - SV-254266r849353_rule
      - CCI-001233
      - CAT2

- name: "MEDIUM | WN22-00-000300 | AUDIT | Windows Server 2022 must automatically remove or disable temporary user accounts after 72 hours."
  block:
      - name: "MEDIUM | WN22-00-000300 | AUDIT | Windows Server 2022 must automatically remove or disable temporary user accounts after 72 hours."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must automatically remove or disable temporary user accounts after 72 hours."

      - name: "MEDIUM | WN22-00-000300 | AUDIT | Windows Server 2022 must automatically remove or disable temporary user accounts after 72 hours. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000300'
  when:
      - wn22_00_000300
  tags:
      - WN22-00-000300
      - V-254267
      - SRG-OS-000002-GPOS-00002
      - SV-254267r848617_rule
      - CCI-000016
      - CAT2

- name: "MEDIUM | WN22-00-000310 | AUDIT | Windows Server 2022 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours."
  block:
      - name: "MEDIUM | WN22-00-000310 | AUDIT | Windows Server 2022 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours."

      - name: "MEDIUM | WN22-00-000310 | AUDIT | Windows Server 2022 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000310'
  when:
      - wn22_00_000310
  tags:
      - WN22-00-000310
      - V-254268
      - SRG-OS-000123-GPOS-00064
      - SV-254268r848620_rule
      - CCI-001682
      - CAT2

- name: "MEDIUM | WN22-00-000320 | PATCH | Windows Server 2022 must not have the Fax Server role installed."
  ansible.windows.win_feature:
      name: Fax
      state: absent
  notify: reboot_windows
  when:
      - wn22_00_000320
  tags:
      - WN22-00-000320
      - V-254269
      - SRG-OS-000095-GPOS-00049
      - SV-254269r848623_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000330 | PATCH | Windows Server 2022 must not have the Microsoft FTP service installed unless required by the organization."
  ansible.windows.win_feature:
      name: Web-Ftp-Server
      state: absent
  notify: reboot_windows
  when:
      - wn22_00_000330
  tags:
      - WN22-00-000330
      - V-254270
      - SRG-OS-000096-GPOS-00050
      - SV-254270r848626_rule
      - CCI-000382
      - CAT2

- name: "MEDIUM | WN22-00-000340 | PATCH | Windows Server 2022 must not have the Peer Name Resolution Protocol installed."
  ansible.windows.win_feature:
      name: PNRP
      state: absent
  notify: reboot_windows
  when:
      - wn22_00_000340
  tags:
      - WN22-00-000340
      - V-254271
      - SRG-OS-000095-GPOS-00049
      - SV-254271r848629_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000350 | PATCH | Windows Server 2022 must not have Simple TCP/IP Services installed."
  ansible.windows.win_feature:
      name: Simple-TCPIP
      state: absent
  when:
      - wn22_00_000350
  tags:
      - WN22-00-000350
      - V-254272
      - SRG-OS-000095-GPOS-00049
      - SV-254272r848632_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000360 | PATCH | Windows Server 2022 must not have the Telnet Client installed."
  ansible.windows.win_feature:
      name: Telnet-Client
      state: absent
  when:
      - wn22_00_000360
  tags:
      - WN22-00-000360
      - V-254273
      - SRG-OS-000096-GPOS-00050
      - SV-254273r848635_rule
      - CCI-000382
      - CAT2

- name: "MEDIUM | WN22-00-000370 | PATCH | Windows Server 2022 must not have the TFTP Client installed."
  ansible.windows.win_feature:
      name: TFTP-Client
      state: absent
  when:
      - wn22_00_000370
  tags:
      - WN22-00-000370
      - V-254274
      - SRG-OS-000095-GPOS-00049
      - SV-254274r848638_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000380 | PATCH | Windows Server 2022 must not have the Server Message Block (SMB) v1 protocol installed."
  ansible.windows.win_feature:
      name: FS-SMB1
      state: absent
  notify: reboot_windows
  when:
      - wn22_00_000380
  tags:
      - WN22-00-000380
      - V-254275
      - CAT2
      - SRG-OS-000095-GPOS-00049
      - SV-254275r848641_rule
      - CCI-000381

- name: "MEDIUM | WN22-00-000390 | PATCH | Windows Server 2022 must have the Server Message Block (SMB) v1 protocol disabled on the SMB server."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
      name: SMB1
      data: 0x00000000
      type: dword
  notify: reboot_windows
  when:
      - wn22_00_000390
  tags:
      - WN22-00-000390
      - V-254276
      - SRG-OS-000095-GPOS-00049
      - SV-254276r848644_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000400 | PATCH | Windows Server 2022 must have the Server Message Block (SMB) v1 protocol disabled on the SMB server."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\mrxsmb10
      name: Start
      data: 0x00000004
      type: dword
  notify: reboot_windows
  when:
      - wn22_00_000400
  tags:
      - WN22-00-000400
      - V-254277
      - SRG-OS-000095-GPOS-00049
      - SV-254277r848647_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000410 | PATCH | Windows Server 2022 must not have Windows PowerShell 2.0 installed."
  ansible.windows.win_feature:
      name: PowerShell-V2
      state: absent
  when:
      - wn22_00_000410
  tags:
      - WN22-00-000410
      - V-254278
      - SRG-OS-000095-GPOS-00049
      - SV-254278r848650_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-00-000420 | AUDIT | Windows Server 2022 FTP servers must be configured to prevent anonymous logons."
  block:
      - name: "MEDIUM | WN22-00-000420 | AUDIT | Windows Server 2022 FTP servers must be configured to prevent anonymous logons."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 FTP servers must be configured to prevent anonymous logons."

      - name: "MEDIUM | WN22-00-000420 | AUDIT | Windows Server 2022 FTP servers must be configured to prevent anonymous logons. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000420'
  when:
      - wn22_00_000420
  tags:
      - WN22-00-000420
      - V-254279
      - SRG-OS-000480-GPOS-00227
      - SV-254279r848653_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-00-000430 | AUDIT | Windows Server 2022 FTP servers must be configured to prevent access to the system drive."
  block:
      - name: "MEDIUM | WN22-00-000430 | AUDIT | Windows Server 2022 FTP servers must be configured to prevent access to the system drive."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 FTP servers must be configured to prevent access to the system drive."

      - name: "MEDIUM | WN22-00-000430 | AUDIT | Windows Server 2022 FTP servers must be configured to prevent access to the system drive. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000430'
  when:
      - wn22_00_000430
  tags:
      - WN22-00-000430
      - V-254280
      - SRG-OS-000480-GPOS-00227
      - SV-254280r848656_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-00-000450 | AUDIT | Windows Server 2022 must have orphaned security identifiers (SIDs) must be removed from user rights"
  block:
      - name: "MEDIUM | WN22-00-000450 | AUDIT | Windows Server 2022 must have orphaned security identifiers (SIDs) must be removed from user rights"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have orphaned security identifiers (SIDs) must be removed from user rights"

      - name: "MEDIUM | WN22-00-000450 | AUDIT | Windows Server 2022 must have orphaned security identifiers (SIDs) must be removed from user rights | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000450'
  when:
      - wn22_00_000450
  tags:
      - WN22-00-000450
      - V-254282
      - SRG-OS-000480-GPOS-00227
      - SV-254282r848662_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-00-000460 | AUDIT | Windows Server 2022 systems must have Unified Extensible Firmware Interface (UEFI) firmware and be configured to run in UEFI mode, not Legacy BIOS."
  block:
      - name: "MEDIUM | WN22-00-000460 | AUDIT | Windows Server 2022 systems must have Unified Extensible Firmware Interface (UEFI) firmware and be configured to run in UEFI mode, not Legacy BIOS."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 systems must have Unified Extensible Firmware Interface (UEFI) firmware and be configured to run in UEFI mode, not Legacy BIOS."

      - name: "MEDIUM | WN22-00-000460 | AUDIT | Windows Server 2022 systems must have Unified Extensible Firmware Interface (UEFI) firmware and be configured to run in UEFI mode, not Legacy BIOS. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000460'
  when:
      - wn22_00_000460
  tags:
      - WN22-00-000460
      - V-254283
      - SRG-OS-000480-GPOS-00227
      - SV-254283r848665_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-00-000470 | AUDIT | Windows Server 2022 must have Secure Boot enabled."
  block:
      - name: "MEDIUM | WN22-00-000470 | AUDIT | Windows Server 2022 must have Secure Boot enabled."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have Secure Boot enabled. "

      - name: "MEDIUM | WN22-00-000470 | AUDIT | Windows Server 2022 must have Secure Boot enabled. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-00-000470'
  when:
      - wn22_00_000470
  tags:
      - WN22-00-000470
      - V-254284
      - SRG-OS-000480-GPOS-00227
      - SV-254284r848668_rule
      - CCI-000366
      - CAT2

# THE FOLLOWING 3 CONTROLS WILL FAIL UNLESS THEY ARE IN THE FOLLOWING ORDER FOR LOCAL BASED SYSTEMS.
- name: "MEDIUM | WN22-AC-000020 | PATCH | Windows Server 2022 must have the number of allowed bad logon attempts configured to three or less."
  block:
      - name: "MEDIUM | WN22-AC-000020 | AUDIT | Windows Server 2022 must have the number of allowed bad logon attempts configured to three or less. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn22stig_lockoutbadcount please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn22stig_lockoutbadcount == 0 or
              wn22stig_lockoutbadcount > 3

      - name: "MEDIUM | WN22-AC-000020 | AUDIT | Windows Server 2022 must have the number of allowed bad logon attempts configured to three or less. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AC-000020'
        when:
            - wn22stig_lockoutbadcount == 0 or
              wn22stig_lockoutbadcount > 3

      - name: "MEDIUM | WN22-AC-000020 | PATCH | Windows Server 2022 must have the number of allowed bad logon attempts configured to three or less. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: LockoutBadCount
            value: "{{ wn22stig_lockoutbadcount }}"
        when:
            - wn22stig_lockoutbadcount > 0
            - wn22stig_lockoutbadcount <= 3

  when:
      - wn22_ac_000020
  tags:
      - WN22-AC-000020
      - V-254286
      - SRG-OS-000021-GPOS-00005
      - SV-254286r848674_rule
      - CCI-000044
      - CAT2

- name: "MEDIUM | WN22-AC-000030 | PATCH | Windows Server 2022 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater. | Apply Variable"
  community.windows.win_security_policy:
      section: System Access
      key: ResetLockoutCount
      value: "{{ wn22stig_resetlockoutcount }}"
      when:
          - wn22stig_resetlockoutcount >= 15
  when:
      - wn22_ac_000030
  tags:
      - WN22-AC-000030
      - V-254287
      - SRG-OS-000021-GPOS-00005
      - SV-254287r848677_rule
      - CCI-000044
      - CCI-002238
      - CAT2

# below task is dependent on WN22-AC-000020 and WN22-AC-000030, maybe custom fail when known error if WN22-AC-000020 not set? "The key 'LockoutDuration' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN22-AC-000010 | PATCH | Windows Server 2022 account lockout duration must be configured to 15 minutes or greater."
  block:
      - name: "MEDIUM | WN22-AC-000010 | PATCH | Windows Server 2022 account lockout duration must be configured to 15 minutes or greater. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of minutes set for wn22stig_lockoutduration please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn22stig_lockoutduration < 15
            - wn22stig_lockoutduration > 0

      - name: "MEDIUM | WN22-AC-000010 | PATCH | Windows Server 2022 account lockout duration must be configured to 15 minutes or greater. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AC-000010'
        when:
            - wn22stig_lockoutduration < 15
            - wn22stig_lockoutduration > 0

      - name: "MEDIUM | WN22-AC-000010 | PATCH | Windows Server 2022 account lockout duration must be configured to 15 minutes or greater. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: LockoutDuration
            value: "{{ wn22stig_lockoutduration }}"
        when:
            - wn22stig_lockoutduration == 0 or
              wn22stig_lockoutduration >= 15
  when:
      - wn22_ac_000010
  tags:
      - WN22-AC-000010
      - V-254285
      - SRG-OS-000329-GPOS-00128
      - SV-254285r848671_rule
      - CCI-002238
      - CAT2

# below task is dependent on WN16-AC-000020, maybe custom fail when known error if WN16-AC-000020 not set? "The key 'ResetLockoutCount' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN22-AC-000030 | PATCH | Windows Server 2022 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
  block:
      - name: MEDIUM | WN22-AC-000030 | AUDIT | Windows Server 2022 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn22stig_resetlockoutcount please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn22stig_resetlockoutcount < 15

      - name: MEDIUM | WN22-AC-000030 | AUDIT | Windows Server 2022 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AC-000030'
        when:
            - wn22stig_resetlockoutcount < 15

- name: "MEDIUM | WN22-AC-000040 | PATCH | Windows Server 2022 password history must be configured to 24 passwords remembered."
  community.windows.win_security_policy:
      section: System Access
      key: PasswordHistorySize
      value: 24
  when:
      - wn22_ac_000040
  tags:
      - WN22-AC-000040
      - V-254288
      - SRG-OS-000077-GPOS-00045
      - SV-254288r848680_rule
      - CCI-000200
      - CAT2

- name: "MEDIUM | WN22-AC-000050 | PATCH | Windows Server 2022 maximum password age must be configured to 60 days or less."
  block:
      - name: "MEDIUM | WN22-AC-000050 | AUDIT | Windows Server 2022 maximum password age must be configured to 60 days or less. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn22stig_maximumpasswordage please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn22stig_maximumpasswordage == 0 or
              wn22stig_maximumpasswordage > 60

      - name: "MEDIUM | WN22-AC-000050 | AUDIT | Windows Server 2022 maximum password age must be configured to 60 days or less. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AC-000050'
        when:
            - wn22stig_maximumpasswordage == 0 or
              wn22stig_maximumpasswordage > 60

      - name: "MEDIUM | WN22-AC-000050 | PATCH | Windows Server 2022 maximum password age must be configured to 60 days or less. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: MaximumPasswordAge
            value: "{{ wn22stig_maximumpasswordage }}"
        when:
            - wn22stig_maximumpasswordage > 0
            - wn22stig_maximumpasswordage <= 60
  when:
      - wn22_ac_000050
  tags:
      - WN22-AC-000050
      - V-254289
      - SRG-OS-000076-GPOS-00044
      - SV-254289r848683_rule
      - CCI-000199
      - CAT2

- name: "MEDIUM | WN22-AC-000060 | PATCH | Windows Server 2022 minimum password age must be configured to at least one day."
  block:
      - name: "MEDIUM | WN22-AC-000060 | AUDIT | Windows Server 2022 minimum password age must be configured to at least one day. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn22stig_minimumpasswordage please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn22stig_minimumpasswordage == 0

      - name: "MEDIUM | WN22-AC-000060 | AUDIT | Windows Server 2022 minimum password age must be configured to at least one day. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AC-000060'
        when:
            wn22stig_minimumpasswordage == 0

      - name: "MEDIUM | WN22-AC-000060 | PATCH | Windows Server 2022 minimum password age must be configured to at least one day. | Set Variable."
        community.windows.win_security_policy:
            section: System Access
            key: MinimumPasswordAge
            value: "{{ wn22stig_minimumpasswordage }}"
        when:
            wn22stig_minimumpasswordage > 0
  when:
      - wn22_ac_000060
  tags:
      - WN22-AC-000060
      - V-254290
      - SRG-OS-000075-GPOS-00043
      - SV-254290r848686_rule
      - CCI-000198
      - CAT2

- name: "MEDIUM | WN22-AC-000070 | PATCH | Windows Server 2022 minimum password length must be configured to 14 characters."
  block:
      - name: "MEDIUM | WN22-AC-000070 | AUDIT | Windows Server 2022 minimum password length must be configured to 14 characters. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid password length for wn22stig_minimumpasswordlength please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn22stig_minimumpasswordlength < 14

      - name: "MEDIUM | WN22-AC-000070 | AUDIT | Windows Server 2022 minimum password length must be configured to 14 characters. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AC-000070'
        when:
            - wn22stig_minimumpasswordlength < 14

      - name: "MEDIUM | WN22-AC-000070 | PATCH | Windows Server 2022 minimum password length must be configured to 14 characters. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: MinimumPasswordLength
            value: "{{ wn22stig_minimumpasswordlength }}"
        when:
            - wn22stig_minimumpasswordlength >= 14
  when:
      - wn22_ac_000070
  tags:
      - WN22-AC-000070
      - V-254291
      - SRG-OS-000078-GPOS-00046
      - SV-254291r890539_rule
      - CCI-000205
      - CAT2

- name: "MEDIUM | WN22-AC-000080 | PATCH | Windows Server 2022 must have the built-in Windows password complexity policy enabled."
  community.windows.win_security_policy:
      section: System Access
      key: PasswordComplexity
      value: 1
  when:
      - wn22_ac_000080
  tags:
      - WN22-AC-000080
      - V-254292
      - SRG-OS-000069-GPOS-00037
      - SV-254292r848692_rule
      - CCI-000192
      - CCI-000193
      - CCI-000194
      - CCI-001619
      - CAT2

- name: "MEDIUM | WN22-AU-000010 | AUDIT | Windows Server 2022 audit records must be backed up to a different system or media than the system being audited."
  block:
      - name: "MEDIUM | WN22-AU-000010 | AUDIT | Windows Server 2022 audit records must be backed up to a different system or media than the system being audited."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 audit records must be backed up to a different system or media than the system being audited."

      - name: "MEDIUM | WN22-AU-000010 | AUDIT | Windows Server 2022 audit records must be backed up to a different system or media than the system being audited. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AU-000010'
  when:
      - wn22_au_000010
  tags:
      - WN22-AU-000010
      - V-254294
      - SRG-OS-000342-GPOS-00133
      - SV-254294r877390_rule
      - CCI-001851
      - CAT2

- name: "MEDIUM | WN22-AU-000020 | AUDIT | Windows Server 2022 must, at a minimum, offload audit records of interconnected systems in real time and offload standalone or nondomain-joined systems weekly."
  block:
      - name: "MEDIUM | WN22-AU-000020 | AUDIT | Windows Server 2022 must, at a minimum, offload audit records of interconnected systems in real time and offload standalone or nondomain-joined systems weekly."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must, at a minimum, offload audit records of interconnected systems in real time and offload standalone or nondomain-joined systems weekly."

      - name: "MEDIUM | WN22-AU-000020 | AUDIT | Windows Server 2022 must, at a minimum, offload audit records of interconnected systems in real time and offload standalone or nondomain-joined systems weekly. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AU-000020'
  when:
      - wn22_au_000020
  tags:
      - WN22-AU-000020
      - V-254295
      - SRG-OS-000479-GPOS-00224
      - SV-254295r848701_rule
      - CCI-001851
      - CAT2

- name: "MEDIUM | WN22-AU-000030 | AUDIT | Windows Server 2022 permissions for the Application event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN22-AU-000030 | AUDIT | Windows Server 2022 permissions for the Application event log must prevent access by non-privileged accounts."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 permissions for the Application event log must prevent access by non-privileged accounts."

      - name: "MEDIUM | WN22-AU-000030 | AUDIT | Windows Server 2022 permissions for the Application event log must prevent access by non-privileged accounts. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AU-000030'
  when:
      - wn22_au_000030
  tags:
      - WN22-AU-000030
      - V-254296
      - SRG-OS-000057-GPOS-00027
      - SV-254296r848704_rule
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CAT2

- name: "MEDIUM | WN22-AU-000040 | AUDIT | Windows Server 2022 permissions for the Security event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN22-AU-000040 | AUDIT | Windows Server 2022 permissions for the Security event log must prevent access by non-privileged accounts."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 permissions for the Security event log must prevent access by non-privileged accounts."

      - name: "MEDIUM | WN22-AU-000040 | AUDIT | Windows Server 2022 permissions for the Security event log must prevent access by non-privileged accounts. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AU-000040'
  when:
      - wn22_au_000040
  tags:
      - WN22-AU-000040
      - V-254297
      - SRG-OS-000057-GPOS-00027
      - SV-254297r848707_rule
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CAT2

- name: "MEDIUM | WN22-AU-000050 | AUDIT | Windows Server 2022 permissions for the System event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN22-AU-000050 | AUDIT | Windows Server 2022 permissions for the System event log must prevent access by non-privileged accounts."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 permissions for the System event log must prevent access by non-privileged accounts."

      - name: "MEDIUM | WN22-AU-000050 | AUDIT | Windows Server 2022 permissions for the System event log must prevent access by non-privileged accounts. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AU-000050'
  when:
      - wn22_au_000050
  tags:
      - WN22-AU-000050
      - V-254298
      - SRG-OS-000057-GPOS-00027
      - SV-254298r848710_rule
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CAT2

- name: "MEDIUM | WN22-AU-000060 | AUDIT | Windows Server 2022 Event Viewer must be protected from unauthorized modification and deletion."
  block:
      - name: "MEDIUM | WN22-AU-000060 | AUDIT | Windows Server 2022 Event Viewer must be protected from unauthorized modification and deletion."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Event Viewer must be protected from unauthorized modification and deletion."

      - name: "MEDIUM | WN22-AU-000060 | AUDIT | Windows Server 2022 Event Viewer must be protected from unauthorized modification and deletion. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-AU-000060'
  when:
      - wn22_au_000060
  tags:
      - WN22-AU-000060
      - V-254299
      - SRG-OS-000257-GPOS-00098
      - SV-254299r848713_rule
      - CCI-001494
      - CCI-001495
      - CAT2

- name: "MEDIUM | WN22-AU-000070 | PATCH | Windows Server 2022 must be configured to audit Account Logon - Credential Validation successes."
  block:
      - name: "MEDIUM | WN22-AU-000070 | AUDIT | Windows Server 2022 must be configured to audit Account Logon - Credential Validation successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000070_audit

      - name: "MEDIUM | WN22-AU-000070 | PATCH | Windows Server 2022 must be configured to audit Account Logon - Credential Validation successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Credential Validation" /success:enable
        when: "'Success' not in wn22_au_000070_audit.stdout"
  when:
      - wn22_au_000070
  tags:
      - WN22-AU-000070
      - V-254300
      - SRG-OS-000470-GPOS-00214
      - SV-254300r848716_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000080 | PATCH | Windows Server 2022 must be configured to audit Account Logon - Credential Validation failures."
  block:
      - name: "MEDIUM | WN22-AU-000080 | AUDIT | Windows Server 2022 must be configured to audit Account Logon - Credential Validation failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000080_audit

      - name: "MEDIUM | WN22-AU-000080 | PATCH | Windows Server 2022 must be configured to audit Account Logon - Credential Validation failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Credential Validation" /failure:enable
        when: "'Failure' not in wn22_au_000080_audit.stdout"
  when:
      - wn22_au_000080
  tags:
      - WN22-AU-000080
      - V-254301
      - SRG-OS-000470-GPOS-00214
      - SV-254301r848719_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000090 | PATCH | Windows Server 2022 must be configured to audit Account Management - Other Account Management Events successes."
  block:
      - name: "MEDIUM | WN22-AU-000090 | AUDIT | Windows Server 2022 must be configured to audit Account Management - Other Account Management Events successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other Account Management Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000090_audit

      - name: "MEDIUM | WN22-AU-000090 | PATCH | Windows Server 2022 must be configured to audit Account Management - Other Account Management Events successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other Account Management Events" /failure:enable
        when: "'Failure' not in wn22_au_000090_audit.stdout"
  when:
      - wn22_au_000090
  tags:
      - WN22-AU-000090
      - V-254302
      - SRG-OS-000327-GPOS-00127
      - SV-254302r848722_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000100 | PATCH | Windows Server 2022 must be configured to audit Account Management - User Account Management successes."
  block:
      - name: "MEDIUM | WN22-AU-000100 | AUDIT | Windows Server 2022 must be configured to audit Account Management - User Account Management successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000100_audit

      - name: "MEDIUM | WN22-AU-000100 | PATCH | Windows Server 2022 must be configured to audit Account Management - User Account Management successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
        when: "'Success' not in wn22_au_000100_audit.stdout"
  when:
      - wn22_au_000100
  tags:
      - WN22-AU-000100
      - V-254303
      - SRG-OS-000004-GPOS-00004
      - SV-254303r848725_rule
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN22-AU-000110 | PATCH | Windows Server 2022 must be configured to audit Account Management - User Account Management successes."
  block:
      - name: "MEDIUM | WN22-AU-000110 | AUDIT | Windows Server 2022 must be configured to audit Account Management - User Account Management successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000110_audit

      - name: "MEDIUM | WN22-AU-000110 | PATCH | Windows Server 2022 must be configured to audit Account Management - User Account Management successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"User Account Management" /success:enable
        when: "'Success' not in wn22_au_000110_audit.stdout"
  when:
      - wn22_au_000110
  tags:
      - WN22-AU-000110
      - V-254304
      - SRG-OS-000004-GPOS-00004
      - SV-254304r848728_rule
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN22-AU-000120 | PATCH | Windows Server 2022 must be configured to audit Account Management - User Account Management failures."
  block:
      - name: "MEDIUM | WN22-AU-000120 | AUDIT | Windows Server 2022 must be configured to audit Account Management - User Account Management failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000120_audit

      - name: "MEDIUM | WN22-AU-000120 | PATCH | Windows Server 2022 must be configured to audit Account Management - User Account Management failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"User Account Management" /failure:enable
        when: "'Failure' not in wn22_au_000120_audit.stdout"
  when:
      - wn22_au_000120
  tags:
      - WN22-AU-000120
      - V-254305
      - SRG-OS-000004-GPOS-00004
      - SV-254305r848731_rule
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN22-AU-000130 | PATCH | Windows Server 2022 must be configured to audit Detailed Tracking - Plug and Play Events successes."
  block:
      - name: "MEDIUM | WN22-AU-000130 | AUDIT | Windows Server 2022 must be configured to audit Detailed Tracking - Plug and Play Events successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Plug and Play Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000130_audit

      - name: "MEDIUM | WN22-AU-000130 | PATCH | Windows Server 2022 must be configured to audit Detailed Tracking - Plug and Play Events successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Plug and Play Events" /success:enable
        when: "'Success' not in wn22_au_000130_audit.stdout"
  when:
      - wn22_au_000130
  tags:
      - WN22-AU-000130
      - V-254306
      - SRG-OS-000474-GPOS-00219
      - SV-254306r848734_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000140 | PATCH | Windows Server 2022 must be configured to audit Detailed Tracking - Process Creation successes."
  block:
      - name: "MEDIUM | WN22-AU-000140 | AUDIT | Windows Server 2022 must be configured to audit Detailed Tracking - Process Creation successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Process Creation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000140_audit

      - name: "MEDIUM | WN22-AU-000140 | PATCH | Windows Server 2022 must be configured to audit Detailed Tracking - Process Creation successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Process Creation" /success:enable
        when: "'Success' not in wn22_au_000140_audit.stdout"
  when:
      - wn22_au_000140
  tags:
      - WN22-AU-000140
      - V-254307
      - SRG-OS-000327-GPOS-00127
      - SV-254307r848737_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000150 | PATCH | Windows Server 2022 must be configured to audit Logon/Logoff - Account Lockout successes."
  block:
      - name: "MEDIUM | WN22-AU-000150 | AUDIT | Windows Server 2022 must be configured to audit Logon/Logoff - Account Lockout successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Account Lockout" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000150_audit

- name: "MEDIUM | WN22-AU-000160 | PATCH | Windows Server 2022 must be configured to audit Logon/Logoff - Account Lockout failures."
  block:
      - name: "MEDIUM | WN22-AU-000160 | AUDIT | Windows Server 2022 must be configured to audit Logon/Logoff - Account Lockout failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Account Lockout" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000160_audit

      - name: "MEDIUM | WN22-AU-000160 | PATCH | Windows Server 2022 must be configured to audit Logon/Logoff - Account Lockout failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Account Lockout" /failure:enable
        when: "'Failure' not in wn22_au_000160_audit.stdout"
  when:
      - wn22_au_000160
  tags:
      - WN22-AU-000160
      - V-254309
      - SRG-OS-000240-GPOS-00090
      - SV-254309r848743_rule
      - CCI-000172
      - CCI-001404
      - CAT2

- name: "MEDIUM | WN22-AU-000170 | PATCH | Windows Server 2022 must be configured to audit Logon/Logoff - Group Membership successes."
  block:
      - name: "MEDIUM | WN22-AU-000170 | AUDIT | Windows Server 2022 must be configured to audit Logon/Logoff - Group Membership successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Group Membership" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000170_audit

      - name: "MEDIUM | WN22-AU-000170 | PATCH | Windows Server 2022 must be configured to audit Logon/Logoff - Group Membership successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Group Membership" /success:enable
        when: "'Success' not in wn22_au_000170_audit.stdout"
  when:
      - wn22_au_000170
  tags:
      - WN22-AU-000170
      - V-254310
      - SRG-OS-000470-GPOS-00214
      - SV-254310r848746_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000180 | PATCH | Windows Server 2022 must be configured to audit logoff successes."
  block:
      - name: "MEDIUM | WN22-AU-000180 | AUDIT | Windows Server 2022 must be configured to audit logoff successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logoff" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000180_audit

      - name: "MEDIUM | WN22-AU-000180 | PATCH | Windows Server 2022 must be configured to audit logoff successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logoff" /success:enable
        when: "'Success' not in wn22_au_000180_audit.stdout"
  when:
      - wn22_au_000180
  tags:
      - WN22-AU-000180
      - V-254311
      - SRG-OS-000472-GPOS-00217
      - SV-254311r848749_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000190 | PATCH | Windows Server 2022 must be configured to audit logon successes."
  block:
      - name: "MEDIUM | WN22-AU-000190 | AUDIT | Windows Server 2022 must be configured to audit logon successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000190_audit

      - name: "MEDIUM | WN22-AU-000190 | PATCH  Windows Server 2022 must be configured to audit logon successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logon" /success:enable
        when: "'Success' not in wn22_au_000190_audit.stdout"
  when:
      - wn22_au_000190
  tags:
      - WN22-AU-000190
      - V-254312
      - SRG-OS-000032-GPOS-00013
      - SV-254312r848752_rule
      - CCI-000067
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000200 | PATCH | Windows Server 2022 must be configured to audit logon failures"
  block:
      - name: "MEDIUM | WN22-AU-000200 | AUDIT | Windows Server 2022 must be configured to audit logon failures"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000200_audit

      - name: "MEDIUM | WN22-AU-000200 | PATCH | Windows Server 2022 must be configured to audit logon failures"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logon" /failure:enable
        when: "'Failure' not in wn22_au_000200_audit.stdout"
  when:
      - wn22_au_000200
  tags:
      - WN22-AU-000200
      - V-254313
      - SRG-OS-000032-GPOS-00013
      - SV-254313r848755_rule
      - CCI-000067
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000210 | PATCH | Windows Server 2022 must be configured to audit Logon/Logoff - Special Logon successes."
  block:
      - name: "MEDIUM | WN22-AU-000210 | AUDIT | Windows Server 2022 must be configured to audit Logon/Logoff - Special Logon successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Special Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000210_audit

      - name: "MEDIUM | WN22-AU-000210 | PATCH | Windows Server 2022 must be configured to audit Logon/Logoff - Special Logon successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Special Logon" /success:enable
        when: "'Success' not in wn22_au_000210_audit.stdout"
  when:
      - wn22_au_000210
  tags:
      - WN22-AU-000210
      - V-254314
      - SRG-OS-000470-GPOS-00214
      - SV-254314r848758_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000220 | PATCH | Windows Server 2022 must be configured to audit Object Access - Other Object Access Events successes."
  community.windows.win_audit_policy_system:
      subcategory: Other Object Access Events
      audit_type: success, failure
  when:
      - wn22_au_000220
  tags:
      - WN22-AU-000220
      - V-254315
      - SRG-OS-000470-GPOS-00214
      - SV-254315r848761_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000230 | PATCH | Windows Server 2022 must be configured to audit Object Access - Other Object Access Events failures."
  community.windows.win_audit_policy_system:
      subcategory: Other Object Access Events
      audit_type: success, failure
  when:
      - wn22_au_000230
  tags:
      - WN22-AU-000230
      - V-254316
      - SRG-OS-000470-GPOS-00214
      - SV-254316r848764_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000240 | PATCH | Windows Server 2022 must be configured to audit Object Access - Removable Storage successes."
  block:
      - name: "MEDIUM | WN22-AU-000240 | AUDIT | Windows Server 2022 must be configured to audit Object Access - Removable Storage successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000240_audit

      - name: "MEDIUM | WN22-AU-000240 | PATCH | Windows Server 2022 must be configured to audit Object Access - Removable Storage successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Removable Storage" /success:enable
        when: "'Success' not in wn22_au_000240_audit.stdout"
  when:
      - wn22_au_000240
  tags:
      - WN22-AU-000240
      - V-254317
      - SRG-OS-000474-GPOS-00219
      - SV-254317r848767_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000250 | PATCH | Windows Server 2022 must be configured to audit Object Access - Removable Storage failures."
  block:
      - name: "MEDIUM | WN22-AU-000250 | AUDIT | Windows Server 2022 must be configured to audit Object Access - Removable Storage failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000250_audit

      - name: "MEDIUM | WN22-AU-000250 | PATCH | Windows Server 2022 must be configured to audit Object Access - Removable Storage failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Removable Storage" /failure:enable
        when: "'Failure' not in wn22_au_000250_audit.stdout"
  when:
      - wn22_au_000250
  tags:
      - WN22-AU-000250
      - V-254318
      - SRG-OS-000474-GPOS-00219
      - SV-254318r848770_rule
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN22-AU-000260 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Audit Policy Change successes."
  block:
      - name: "MEDIUM | WN22-AU-000260 | AUDIT | Windows Server 2022 must be configured to audit Policy Change - Audit Policy Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000260_audit

      - name: "MEDIUM | WN22-AU-000260 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Audit Policy Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Audit Policy Change" /success:enable
        when: "'Success' not in wn22_au_000260_audit.stdout"
  when:
      - wn22_au_000260
  tags:
      - WN22-AU-000260
      - V-254319
      - SRG-OS-000327-GPOS-00127
      - SV-254319r848773_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000270 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Audit Policy Change failures."
  block:
      - name: "MEDIUM | WN22-AU-000270 | AUDIT | Windows Server 2022 must be configured to audit Policy Change - Audit Policy Change failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000270_audit

      - name: "MEDIUM | WN22-AU-000270 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Audit Policy Change failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Audit Policy Change" /failure:enable
        when: "'Failure' not in wn22_au_000270_audit.stdout"
  when:
      - wn22_au_000270
  tags:
      - WN22-AU-000270
      - V-254320
      - SRG-OS-000327-GPOS-00127
      - SV-254320r848776_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000280 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Authentication Policy Change successes."
  block:
      - name: "MEDIUM | WN22-AU-000280 | AUDIT | Windows Server 2022 must be configured to audit Policy Change - Authentication Policy Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Authentication Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000280_audit

      - name: "MEDIUM | WN22-AU-000280 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Authentication Policy Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Authentication Policy Change" /success:enable
        when: "'Success' not in wn22_au_000280_audit.stdout"
  when:
      - wn22_au_000280
  tags:
      - WN22-AU-000280
      - V-254321
      - SRG-OS-000327-GPOS-00127
      - SV-254321r848779_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000290 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Authorization Policy Change successes."
  block:
      - name: "MEDIUM | WN22-AU-000290 | AUDIT | Windows Server 2022 must be configured to audit Policy Change - Authorization Policy Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Authorization Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000290_audit

      - name: "MEDIUM | WN22-AU-000290 | PATCH | Windows Server 2022 must be configured to audit Policy Change - Authorization Policy Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /success:enable
        when: "'Success' not in wn22_au_000290_audit.stdout"
  when:
      - wn22_au_000290
  tags:
      - WN22-AU-000290
      - V-254322
      - SRG-OS-000327-GPOS-00127
      - SV-254322r848782_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000300 | PATCH | Windows Server 2022 must be configured to audit Privilege Use - Sensitive Privilege Use successes."
  block:
      - name: "MEDIUM | WN22-AU-000300 | AUDIT | Windows Server 2022 must be configured to audit Privilege Use - Sensitive Privilege Use successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000300_audit

      - name: "MEDIUM | WN22-AU-000300 | PATCH | Windows Server 2022 must be configured to audit Privilege Use - Sensitive Privilege Use successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /success:enable
        when: "'Success' not in wn22_au_000300_audit.stdout"
  when:
      - wn22_au_000300
  tags:
      - WN22-AU-000300
      - V-254323
      - SRG-OS-000327-GPOS-00127
      - SV-254323r848785_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000310 | PATCH | Windows Server 2022 must be configured to audit Privilege Use - Sensitive Privilege Use failures."
  block:
      - name: "MEDIUM | WN22-AU-000310 | AUDIT | Windows Server 2022 must be configured to audit Privilege Use - Sensitive Privilege Use failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000310_audit

      - name: "MEDIUM | WN22-AU-000310 | PATCH | Windows Server 2022 must be configured to audit Privilege Use - Sensitive Privilege Use failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /failure:enable
        when: "'Failure' not in wn22_au_000310_audit.stdout"
  when:
      - wn22_au_000310
  tags:
      - WN22-AU-000310
      - V-254324
      - SRG-OS-000327-GPOS-00127
      - SV-254324r848788_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000320 | PATCH | Windows Server 2022 must be configured to audit System - IPsec Driver successes."
  block:
      - name: "MEDIUM | WN22-AU-000320 | AUDIT | Windows Server 2022 must be configured to audit System - IPsec Driver successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000320_audit

      - name: "MEDIUM | WN22-AU-000320 | PATCH | Windows Server 2022 must be configured to audit System - IPsec Driver successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"IPsec Driver" /success:enable
        when: "'Success' not in wn22_au_000320_audit.stdout"
  when:
      - wn22_au_000320
  tags:
      - WN22-AU-000320
      - V-254325
      - SRG-OS-000327-GPOS-00127
      - SV-254325r848791_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000330 | PATCH | Windows Server 2022 must be configured to audit System - IPsec Driver failures."
  block:
      - name: "MEDIUM | WN22-AU-000330 | AUDIT | Windows Server 2022 must be configured to audit System - IPsec Driver failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000330_audit

      - name: "MEDIUM | WN22-AU-000330 | PATCH | Windows Server 2022 must be configured to audit System - IPsec Driver failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"IPsec Driver" /failure:enable
        when: "'Success' not in wn22_au_000330_audit.stdout"
  when:
      - wn22_au_000330
  tags:
      - WN22-AU-000330
      - V-254326
      - SRG-OS-000327-GPOS-00127
      - SV-254326r848794_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000340 | PATCH | Windows Server 2022 must be configured to audit System - Other System Events successes."
  block:
      - name: "MEDIUM | WN22-AU-000340 | AUDIT | Windows Server 2022 must be configured to audit System - Other System Events successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000340_audit

      - name: "MEDIUM | WN22-AU-000340 | PATCH | Windows Server 2022 must be configured to audit System - Other System Events successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other System Events" /success:enable
        when: "'Success' not in wn22_au_000340_audit.stdout"
  when:
      - wn22_au_000340
  tags:
      - WN22-AU-000340
      - V-254327
      - SRG-OS-000327-GPOS-00127
      - SV-254327r848797_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000350 | PATCH | Windows Server 2022 must be configured to audit System - Other System Events failures."
  block:
      - name: "MEDIUM | WN22-AU-000350 | AUDIT | Windows Server 2022 must be configured to audit System - Other System Events failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000350_audit

      - name: "MEDIUM | WN22-AU-000350 | PATCH | Windows Server 2022 must be configured to audit System - Other System Events failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other System Events" /failure:enable
        when: "'Failure' not in wn22_au_000350_audit.stdout"
  when:
      - wn22_au_000350
  tags:
      - WN22-AU-000350
      - V-254328
      - SRG-OS-000327-GPOS-00127
      - SV-254328r848800_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000360 | PATCH | Windows Server 2022 must be configured to audit System - Security State Change successes."
  block:
      - name: "MEDIUM | WN22-AU-000360 | AUDIT | Windows Server 2022 must be configured to audit System - Security State Change successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security State Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000360_audit

      - name: "MEDIUM | WN22-AU-000360 | PATCH | Windows Server 2022 must be configured to audit System - Security State Change successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security State Change" /success:enable
        when: "'Success' not in wn22_au_000360_audit.stdout"
  when:
      - wn22_au_000360
  tags:
      - WN22-AU-000360
      - V-254329
      - SRG-OS-000327-GPOS-00127
      - SV-254329r848803_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000370 | PATCH | Windows Server 2022 must be configured to audit System - Security System Extension successes."
  block:
      - name: "MEDIUM | WN22-AU-000370 | AUDIT | Must be configured to audit System - Security System Extension successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security System Extension" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000370_audit

      - name: "MEDIUM | WN22-AU-000370 | PATCH | Must be configured to audit System - Security System Extension successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security System Extension" /success:enable
        when: "'Success' not in wn22_au_000370_audit.stdout"
  when:
      - wn22_au_000370
  tags:
      - WN22-AU-000370
      - V-254330
      - SRG-OS-000327-GPOS-00127
      - SV-254330r848806_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000380 | PATCH | Windows Server 2022 must be configured to audit System - System Integrity successes."
  block:
      - name: "MEDIUM | WN22-AU-000380 | AUDIT | Windows Server 2022 must be configured to audit System - System Integrity successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000380_audit

      - name: "MEDIUM | WN22-AU-000380 | PATCH | Windows Server 2022 must be configured to audit System - System Integrity successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"System Integrity" /success:enable
        when: "'Success' not in wn22_au_000380_audit.stdout"
  when:
      - wn22_au_000380
  tags:
      - WN22-AU-000380
      - V-254331
      - SRG-OS-000327-GPOS-00127
      - SV-254331r848809_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-AU-000390 | PATCH | Windows Server 2022 must be configured to audit System - System Integrity failures."
  block:
      - name: "MEDIUM | WN22-AU-000390 | AUDIT | Windows Server 2022 must be configured to audit System - System Integrity failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_au_000390_audit

      - name: "MEDIUM | WN22-AU-000390 | PATCH | Windows Server 2022 must be configured to audit System - System Integrity failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"System Integrity" /failure:enable
        when: "'Failure' not in wn22_au_000390_audit.stdout"
  when:
      - wn22_au_000390
  tags:
      - WN22-AU-000390
      - V-254332
      - SRG-OS-000327-GPOS-00127
      - SV-254332r848812_rule
      - CCI-000172
      - CCI-002234
      - CAT2

# some versions may be core/no gui, may need a prelim to detect?
- name: "MEDIUM | WN22-CC-000010 | PATCH | Windows Server 2022 must prevent the display of slide shows on the lock screen."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization
      value: NoLockScreenSlideshow
      data: 1
      datatype: dword
  when:
      - wn22_cc_000010
  tags:
      - WN22-CC-000010
      - V-254333
      - SRG-OS-000095-GPOS-00049
      - SV-254333r848815_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000020 | PATCH | Windows Server 2022 must have WDigest Authentication disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest
      value: UseLogonCredential
      data: 0
      datatype: dword
  when:
      - wn22_cc_000020
  tags:
      - WN22-CC-000020
      - V-254334
      - SRG-OS-000095-GPOS-00049
      - SV-254334r848818_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000070 | PATCH | Windows Server 2022 insecure logons to an SMB server must be disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\LanmanWorkstation
      value: AllowInsecureGuestAuth
      data: 0
      datatype: dword
  when:
      - wn22_cc_000070
  tags:
      - WN22-CC-000070
      - V-254339
      - SRG-OS-000480-GPOS-00227
      - SV-254339r848833_rule
      - CCI-000366
      - CAT2

# verify if this applies to DC or only MS?
- name: "MEDIUM | WN22-CC-000080 | PATCH | Windows Server 2022 hardened Universal Naming Convention (UNC) paths must be defined to require mutual authentication and integrity for at least the SYSVOL and NETLOGON shares."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\NetworkProvider\HardenedPaths
      value: "{{ item }}"
      data: RequireMutualAuthentication=1, RequireIntegrity=1
      datatype: string
  with_items:
      - \\*\SYSVOL
      - \\*\NETLOGON
  when:
      - wn22_cc_000080
      - ansible_windows_domain_member
  tags:
      - WN22-CC-000080
      - V-254340
      - SRG-OS-000480-GPOS-00227
      - SV-254340r848836_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000090 | PATCH | Windows Server 2022 command line data must be included in process creation events."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit\
      value: ProcessCreationIncludeCmdLine_Enabled
      data: 1
      datatype: dword
  when:
      - wn22_cc_000090
  tags:
      - WN22-CC-000090
      - V-254341
      - SRG-OS-000042-GPOS-00020
      - SV-254341r848839_rule
      - CCI-000135
      - CAT2

- name: "MEDIUM | WN22-CC-000100 | PATCH | Windows Server 2022 must be configured to enable Remote host allows delegation of nonexportable credentials."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation\
      value: AllowProtectedCreds
      data: 1
      datatype: dword
  when:
      - wn22_cc_000100
  tags:
      - WN22-CC-000100
      - V-254342
      - SRG-OS-000480-GPOS-00227
      - SV-254342r848842_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000110 | AUDIT | Windows Server 2022 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection."
  block:
      - name: "MEDIUM | WN22-CC-000110 | AUDIT | Windows Server 2022 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection."

      - name: "MEDIUM | WN22-CC-000110 | AUDIT | Windows Server 2022 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-CC-000110'
  when:
      - wn22_cc_000110
      - ansible_windows_domain_member
  tags:
      - WN22-CC-000110
      - V-254343
      - SRG-OS-000480-GPOS-00227
      - SV-254343r848845_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000130 | PATCH | Windows Server 2022 early Launch Antimalware, Boot-Start Driver Initialization Policy must prevent boot drivers identified as bad."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch
      value: DriverLoadPolicy
      data: 1
      datatype: dword
  when:
      - wn22_cc_000130
  tags:
      - WN22-CC-000130
      - V-254344
      - SRG-OS-000480-GPOS-00227
      - SV-254344r848848_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000140 | PATCH | Windows Server 2022 group policy objects must be reprocessed even if they have not changed."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}
      value: NoGPOListChanges
      data: 0
      datatype: dword
  when:
      - wn22_cc_000140
  tags:
      - WN22-CC-000140
      - V-254345
      - SRG-OS-000480-GPOS-00227
      - SV-254345r848851_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000150 | PATCH | Windows Server 2022 downloading print driver packages over HTTP must be turned off."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
      value: DisableWebPnPDownload
      data: 1
      datatype: dword
  when:
      - wn22_cc_000150
  tags:
      - WN22-CC-000150
      - V-254346
      - SRG-OS-000095-GPOS-00049
      - SV-254346r848854_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000160 | PATCH | Windows Server 2022 printing over HTTP must be turned off."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
      value: DisableHTTPPrinting
      data: 1
      datatype: dword
  when:
      - wn22_cc_000160
  tags:
      - WN22-CC-000160
      - V-254347
      - SRG-OS-000095-GPOS-00049
      - SV-254347r848857_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000170 | PATCH | Windows Server 2022 network selection user interface (UI) must not be displayed on the logon screen."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      value: DontDisplayNetworkSelectionUI
      data: 1
      datatype: dword
  when:
      - wn22_cc_000170
  tags:
      - WN22-CC-000170
      - V-254348
      - SRG-OS-000095-GPOS-00049
      - SV-254348r848860_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000180 | PATCH | Windows Server 2022 users must be prompted to authenticate when the system wakes from sleep (on battery)."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      value: DCSettingIndex
      data: 1
      datatype: dword
  when:
      - wn22_cc_000180
  tags:
      - WN22-CC-000180
      - V-254349
      - SRG-OS-000480-GPOS-00227
      - SV-254349r848863_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000190 | PATCH | Windows Server 2022 users must be prompted to authenticate when the system wakes from sleep (plugged in)."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      value: ACSettingIndex
      data: 1
      datatype: dword
  when:
      - wn22_cc_000190
  tags:
      - WN22-CC-000190
      - V-254350
      - SRG-OS-000480-GPOS-00227
      - SV-254350r848866_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000240 | PATCH | Windows Server 2022 administrator accounts must not be enumerated during elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\CredUI
      value: EnumerateAdministrators
      data: 0
      datatype: dword
  when:
      - wn22_cc_000240
  tags:
      - WN22-CC-000240
      - V-254355
      - SRG-OS-000134-GPOS-00068
      - SV-254355r848881_rule
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN22-CC-000250 | PATCH | Windows Server 2022 Telemetry must be configured to Security or Basic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      value: AllowTelemetry
      data: 0
      datatype: dword
  when:
      - wn22_cc_000250
  tags:
      - WN22-CC-000250
      - V-254356
      - SRG-OS-000480-GPOS-00227
      - SV-254356r916220_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000270 | PATCH | Windows Server 2022 Application event log size must be configured to 32768 KB or greater."
  block:
      - name: "MEDIUM | WN22-CC-000270 | AUDIT | Windows Server 2022 Application event log size must be configured to 32768 KB or greater."
        ansible.windows.win_reg_stat:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
            name: MaxSize
        register: wn22_cc_000270_audit

      - name: "MEDIUM | WN22-CC-000270 | PATCH | Windows Server 2022 Application event log size must be configured to 32768 KB or greater."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
            value: MaxSize
            data: "{{ wn22stig_app_maxsize }}"
            datatype: dword
        when:
            - wn22_cc_000270_audit is defined
            - not wn22_cc_000270_audit.exists or
              wn22_cc_000270_audit.value < 32768
  when:
      - wn22_cc_000270
  tags:
      - WN22-CC-000270
      - V-254358
      - SRG-OS-000341-GPOS-00132
      - SV-254358r877391_rule
      - CCI-001849
      - CAT2

- name: "MEDIUM | WN22-CC-000280 | PATCH | Windows Server 2022 Security event log size must be configured to 196608 KB or greater."
  block:
      - name: "MEDIUM | WN22-CC-000280 | AUDIT | Windows Server 2022 Security event log size must be configured to 196608 KB or greater."
        ansible.windows.win_reg_stat:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security
            name: MaxSize
        register: wn22_cc_000280_audit

      - name: "MEDIUM | WN22-CC-000280 | PATCH | Windows Server 2022 Security event log size must be configured to 196608 KB or greater."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security
            value: MaxSize
            data: "{{ wn22stig_sec_maxsize }}"
            datatype: dword
        when:
            - wn22_cc_000280_audit is defined
            - not wn22_cc_000280_audit.exists or
              wn22_cc_000280_audit.value < 196608
  when:
      - wn22_cc_000280
  tags:
      - WN22-CC-000280
      - V-254359
      - SRG-OS-000341-GPOS-00132
      - SV-254359r877391_rule
      - CCI-001849
      - CAT2

- name: "MEDIUM | WN22-CC-000290 | PATCH | Windows Server 2022 System event log size must be configured to 32768 KB or greater."
  block:
      - name: "MEDIUM | WN22-CC-000290 | AUDIT | Windows Server 2022 System event log size must be configured to 32768 KB or greater."
        ansible.windows.win_reg_stat:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\System
            name: MaxSize
        register: wn22_cc_000290_audit

      - name: "MEDIUM | WN22-CC-000290 | PATCH | Windows Server 2022 System event log size must be configured to 32768 KB or greater."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\System
            value: MaxSize
            data: "{{ wn22stig_sys_maxsize }}"
            datatype: dword
        when:
            - wn22_cc_000290_audit is defined
            - not wn22_cc_000290_audit.exists or
              wn22_cc_000290_audit.value < 32768
  when:
      - wn22_cc_000290
  tags:
      - WN22-CC-000290
      - V-254360
      - SRG-OS-000341-GPOS-00132
      - SV-254360r877391_rule
      - CCI-001849
      - CAT2

- name: "MEDIUM | WN22-CC-000300 | PATCH | Windows Server 2022 Windows Defender SmartScreen must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      value: EnableSmartScreen
      data: 1
      datatype: dword
  when:
      - wn22_cc_000300
  tags:
      - WN22-CC-000300
      - V-254361
      - SRG-OS-000095-GPOS-00049
      - SV-254361r848899_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000310 | PATCH | Windows Server 2022 Explorer Data Execution Prevention must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Explorer
      value: NoDataExecutionPrevention
      data: 0
      datatype: dword
  when:
      - wn22_cc_000310
  tags:
      - WN22-CC-000310
      - V-254362
      - SRG-OS-000433-GPOS-00192
      - SV-254362r848902_rule
      - CCI-002824
      - CAT2

- name: "MEDIUM | WN22-CC-000330 | PATCH | Windows Server 2022 File Explorer shell protocol must run in protected mode."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
      value: PreXPSP2ShellProtocolBehavior
      data: 0
      datatype: dword
  when:
      - wn22_cc_000330
  tags:
      - WN22-CC-000330
      - V-254364
      - SRG-OS-000480-GPOS-00227
      - SV-254364r848908_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000340 | PATCH | Windows Server 2022 must not save passwords in the Remote Desktop Client."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      value: DisablePasswordSaving
      data: 1
      datatype: dword
  when:
      - wn22_cc_000340
  tags:
      - WN22-CC-000340
      - V-254365
      - SRG-OS-000373-GPOS-00156
      - SV-254365r848911_rule
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN22-CC-000350 | PATCH | Windows Server 2022 Remote Desktop Services must prevent drive redirection."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      value: fDisableCdm
      data: 1
      datatype: dword
  when:
      - wn22_cc_000350
  tags:
      - WN22-CC-000350
      - V-254366
      - SRG-OS-000138-GPOS-00069
      - SV-254366r848914_rule
      - CCI-001090
      - CAT2

- name: "MEDIUM | WN22-CC-000360 | PATCH | Windows Server 2022 remote Desktop Services must always prompt a client for passwords upon connection."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      value: fPromptForPassword
      data: 1
      datatype: dword
  when:
      - wn22_cc_000360
  tags:
      - WN22-CC-000360
      - V-254367
      - SRG-OS-000373-GPOS-00156
      - SV-254367r848917_rule
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN22-CC-000370 | PATCH | Windows Server 2022 Remote Desktop Services must require secure Remote Procedure Call (RPC) communications."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      value: fEncryptRPCTraffic
      data: 1
      datatype: dword
  when:
      - wn22_cc_000370
  tags:
      - WN22-CC-000370
      - V-254368
      - SRG-OS-000033-GPOS-00014
      - SV-254368r877398_rule
      - CCI-000068
      - CCI-001453
      - CAT2

- name: "MEDIUM | WN22-CC-000380 | PATCH | Windows Server 2022 remote Desktop Services must be configured with the client connection encryption set to High Level."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      value: MinEncryptionLevel
      data: 3
      datatype: dword
  when:
      - wn22_cc_000380
  tags:
      - WN22-CC-000380
      - V-254369
      - SRG-OS-000033-GPOS-00014
      - SRG-OS-000250-GPOS-00093
      - SV-254369r877398_rule
      - CCI-000068
      - CCI-001453
      - CAT2

- name: "MEDIUM | WN22-CC-000390 | PATCH | Windows Server 2022 must prevent attachments from being downloaded from RSS feeds."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds
      value: DisableEnclosureDownload
      data: 1
      datatype: dword
  when:
      - wn22_cc_000390
  tags:
      - WN22-CC-000390
      - V-254370
      - SRG-OS-000480-GPOS-00227
      - SV-254370r848926_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000400 | PATCH | Windows Server 2022 must disable Basic authentication for RSS feeds over HTTP."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds
      value: AllowBasicAuthInClear
      data: 0
      datatype: dword
  when:
      - wn22_cc_000400
  tags:
      - WN22-CC-000400
      - V-254371
      - SRG-OS-000095-GPOS-00049
      - SV-254371r848929_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000410 | PATCH | Windows Server 2022 must prevent Indexing of encrypted files."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Search
      value: AllowIndexingEncryptedStoresOrItems
      data: 0
      datatype: dword
  when:
      - wn22_cc_000410
  tags:
      - WN22-CC-000410
      - V-254372
      - SRG-OS-000095-GPOS-00049
      - SV-254372r848932_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-CC-000420 | PATCH | Windows Server 2022 must prevent users from changing installation options."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer
      value: EnableUserControl
      data: 0
      datatype: dword
  when:
      - wn22_cc_000420
  tags:
      - WN22-CC-000420
      - V-254373
      - SRG-OS-000362-GPOS-00149
      - SV-254373r848935_rule
      - CCI-001812
      - CAT2

- name: "MEDIUM | WN22-CC-000440 | PATCH | Windows Server 2022  users must be notified if a web-based program attempts to install software."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer
      value: SafeForScripting
      data: 0
      datatype: dword
  when:
      - wn22_cc_000440
  tags:
      - WN22-CC-000440
      - V-254375
      - SRG-OS-000480-GPOS-00227
      - SV-254375r848941_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000450 | PATCH | Windows Server 2022 must disable automatically signing in the last interactive user after a system-initiated restart."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: DisableAutomaticRestartSignOn
      data: 1
      datatype: dword
  when:
      - wn22_cc_000450
  tags:
      - WN22-CC-000450
      - V-254376
      - SRG-OS-000480-GPOS-00229
      - SV-254376r877377_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-CC-000460 | PATCH | Windows Server 2022 PowerShell script block logging must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
      value: EnableScriptBlockLogging
      data: 1
      datatype: dword
  when:
      - wn22_cc_000460
  tags:
      - WN22-CC-000460
      - V-254377
      - SRG-OS-000042-GPOS-00020
      - SV-254377r848947_rule
      - CCI-000135
      - CAT2

- name: "MEDIUM | WN22-CC-000480 | PATCH | Windows Server 2022 Windows Remote Management (WinRM) client must not allow unencrypted traffic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  when:
      - wn22_cc_000480
      - not win2022stig_skip_secure_winrm
  tags:
      - WN22-CC-000480
      - V-254379
      - SRG-OS-000393-GPOS-00173
      - SV-254379r877382_rule
      - CCI-002890
      - CCI-003123
      - CAT2

- name: "MEDIUM | WN22-CC-000490 | PATCH | Windows Server 2022 Windows Remote Management (WinRM) client must not use Digest authentication."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client
      value: AllowDigest
      data: 0
      datatype: dword
  when:
      - wn22_cc_000490
  tags:
      - WN22-CC-000490
      - V-254380
      - SRG-OS-000125-GPOS-00065
      - SV-254380r877395_rule
      - CCI-000877
      - CAT2

- name: "MEDIUM | WN22-CC-000510 | PATCH | Windows Server 2022 Windows Remote Management (WinRM) service must not allow unencrypted traffic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  when:
      - wn22_cc_000510
      - not win2022stig_skip_secure_winrm
  tags:
      - WN22-CC-000510
      - V-254382
      - SRG-OS-000393-GPOS-00173
      - SV-254382r877382_rule
      - CCI-002890
      - CCI-003123
      - CAT2

- name: "MEDIUM | WN22-CC-000520 | PATCH | Windows Server 2022 Windows Remote Management (WinRM) service must not store RunAs credentials."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service
      value: DisableRunAs
      data: 1
      datatype: dword
  when:
      - wn22_cc_000520
      - not win2022stig_skip_secure_winrm
  tags:
      - WN22-CC-000520
      - V-254383
      - SRG-OS-000373-GPOS-00156
      - SV-254383r848965_rule
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN22-CC-000530 | PATCH | Windows Server 2022 must have PowerShell Transcription enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription\
      value: EnableTranscripting
      data: 1
      datatype: dword
  when:
      - wn22_cc_000530
  tags:
      - WN22-CC-000530
      - V-254384
      - SRG-OS-000041-GPOS-00019
      - SV-254384r848968_rule
      - CCI-000134
      - CAT2

- name: "MEDIUM | WN22-DC-000020 | AUDIT | Windows Server 2022 Kerberos user logon restrictions must be enforced."
  block:
      - name: "MEDIUM | WN22-DC-000020 | AUDIT | Windows Server 2022 Kerberos user logon restrictions must be enforced."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Kerberos user logon restrictions must be enforced."

      - name: "MEDIUM | WN22-DC-000020 | AUDIT | Windows Server 2022 Kerberos user logon restrictions must be enforced. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000020'
  when:
      - wn22_dc_000020
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000020
      - V-254386
      - SRG-OS-000112-GPOS-00057
      - SV-254386r848974_rule
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN22-DC-000030 | AUDIT | Windows Server 2022 Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."
  block:
      - name: "MEDIUM | WN22-DC-000030 | AUDIT | Windows Server 2022 Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."

      - name: "MEDIUM | WN22-DC-000030 | AUDIT | Windows Server 2022 Kerberos service ticket maximum lifetime must be limited to 600 minutes or less. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000030'
  when:
      - wn22_dc_000030
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000030
      - V-254387
      - SRG-OS-000112-GPOS-00057
      - SV-254387r848977_rule
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN22-DC-000040 | AUDIT | Windows Server 2022 Kerberos user ticket lifetime must be limited to 10 hours or less."
  block:
      - name: "MEDIUM | WN22-DC-000040 | AUDIT | Windows Server 2022 Kerberos user ticket lifetime must be limited to 10 hours or less."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Kerberos user ticket lifetime must be limited to 10 hours or less."

      - name: "MEDIUM | WN22-DC-000040 | AUDIT | Windows Server 2022 Kerberos user ticket lifetime must be limited to 10 hours or less. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000040'
  when:
      - wn22_dc_000040
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000040
      - V-254388
      - SRG-OS-000112-GPOS-00057
      - SV-254388r848980_rule
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN22-DC-000050 | AUDIT | Windows Server 2022 Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."
  block:
      - name: "MEDIUM | WN22-DC-000050 | AUDIT | Windows Server 2022 Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."

      - name: "MEDIUM | WN22-DC-000050 | AUDIT | Windows Server 2022 Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less.| import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000050'
  when:
      - wn22_dc_000050
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000050
      - V-254389
      - SRG-OS-000112-GPOS-00057
      - SV-254389r848983_rule
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN22-DC-000060 | AUDIT | Windows Server 2022 computer clock synchronization tolerance must be limited to 5 minutes or less."
  block:
      - name: "MEDIUM | WN22-DC-000060 | AUDIT | Windows Server 2022 computer clock synchronization tolerance must be limited to 5 minutes or less."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 computer clock synchronization tolerance must be limited to 5 minutes or less."

      - name: "MEDIUM | WN22-DC-000060 | AUDIT | Windows Server 2022 computer clock synchronization tolerance must be limited to 5 minutes or less. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000060'
  when:
      - wn22_dc_000060
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000060
      - V-254390
      - SRG-OS-000112-GPOS-00057
      - SV-254390r848986_rule
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN22-DC-000120 | AUDIT | Windows Server 2022 data files owned by users must be on a different logical partition from the directory server data files."
  block:
      - name: "MEDIUM | WN22-DC-000120 | AUDIT | Windows Server 2022 data files owned by users must be on a different logical partition from the directory server data files."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 data files owned by users must be on a different logical partition from the directory server data files."

      - name: "MEDIUM | WN22-DC-000120 | AUDIT | Windows Server 2022 data files owned by users must be on a different logical partition from the directory server data files. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000120'
  when:
      - wn22_dc_000120
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000120
      - V-254396
      - SRG-OS-000138-GPOS-00069
      - SV-254396r849004_rule
      - CCI-001090
      - CAT2

- name: "MEDIUM | WN22-DC-000130 | AUDIT | Windows Server 2022 domain controllers must run on a machine dedicated to that function."
  block:
      - name: "MEDIUM | WN22-DC-000130 | AUDIT | Windows Server 2022 domain controllers must run on a machine dedicated to that function."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 domain controllers must run on a machine dedicated to that function."

      - name: "MEDIUM | WN22-DC-000130 | AUDIT | Windows Server 2022 domain controllers must run on a machine dedicated to that function. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000130'
  when:
      - wn22_dc_000130
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000130
      - V-254397
      - SRG-OS-000095-GPOS-00049
      - SV-254397r849007_rule
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN22-DC-000140 | AUDIT | Windows Server 2022 must use separate, NSA-approved (Type 1) cryptography to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data."
  block:
      - name: "MEDIUM | WN22-DC-000140 | AUDIT | Windows Server 2022 must use separate, NSA-approved (Type 1) cryptography to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must use separate, NSA-approved (Type 1) cryptography to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data."

      - name: "MEDIUM | WN22-DC-000140 | AUDIT | Windows Server 2022 must use separate, NSA-approved (Type 1) cryptography to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000140'
  when:
      - wn22_dc_000140
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000140
      - V-254398
      - SRG-OS-000396-GPOS-00176
      - SV-254398r877380_rule
      - CCI-002450
      - CAT2

- name: "MEDIUM | WN22-DC-000170 | AUDIT | Windows Server 2022 Active Directory Group Policy objects must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN22-DC-000170 | AUDIT | Windows Server 2022 Active Directory Group Policy objects must be configured with proper audit settings."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Active Directory Group Policy objects must be configured with proper audit settings."

      - name: "MEDIUM | WN22-DC-000170 | AUDIT | Windows Server 2022 Active Directory Group Policy objects must be configured with proper audit settings. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000170'
  when:
      - wn22_dc_000170
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000170
      - V-254401
      - SRG-OS-000327-GPOS-00127
      - SV-254401r849019_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-DC-000180 | AUDIT | Windows Server 2022 Active Directory Domain object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN22-DC-000180 | AUDIT | Windows Server 2022 Active Directory Domain object must be configured with proper audit settings."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Active Directory Domain object must be configured with proper audit settings."

      - name: "MEDIUM | WN22-DC-000180 | AUDIT | Windows Server 2022 Active Directory Domain object must be configured with proper audit settings. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000180'
  when:
      - wn22_dc_000180
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000180
      - V-254402
      - SRG-OS-000327-GPOS-00127
      - SV-254402r849022_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-DC-000190 | AUDIT | Windows Server 2022 Active Directory Infrastructure object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN22-DC-000190 | AUDIT | Windows Server 2022 Active Directory Infrastructure object must be configured with proper audit settings."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Active Directory Infrastructure object must be configured with proper audit settings."

      - name: "MEDIUM | WN22-DC-000190 | AUDIT | Windows Server 2022 Active Directory Infrastructure object must be configured with proper audit settings. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000190'
  when:
      - wn22_dc_000190
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000190
      - V-254403
      - SRG-OS-000327-GPOS-00127
      - SV-254403r849025_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-DC-000200 | AUDIT | Windows Server 2022 Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN22-DC-000200 | AUDIT | Windows Server 2022 Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings."

      - name: "MEDIUM | WN22-DC-000200 | AUDIT | Windows Server 2022 Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000200'
  when:
      - wn22_dc_000200
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000200
      - V-254404
      - SRG-OS-000327-GPOS-00127
      - SV-254404r849028_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-DC-000210 | AUDIT | Windows Server 2022 Active Directory AdminSDHolder object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN22-DC-000210 | AUDIT | Windows Server 2022 Active Directory AdminSDHolder object must be configured with proper audit settings."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Active Directory AdminSDHolder object must be configured with proper audit settings."

      - name: "MEDIUM | WN22-DC-000210 | AUDIT | Windows Server 2022 Active Directory AdminSDHolder object must be configured with proper audit settings. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000210'
  when:
      - wn22_dc_000210
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000210
      - V-254405
      - SRG-OS-000327-GPOS-00127
      - SV-254405r849031_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-DC-000220 | AUDIT | Windows Server 2022 Active Directory RID Manager$ object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN22-DC-000220 | AUDIT | Windows Server 2022 Active Directory RID Manager$ object must be configured with proper audit settings."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Active Directory RID Manager$ object must be configured with proper audit settings."

      - name: "MEDIUM | WN22-DC-000220 | AUDIT | Windows Server 2022 Active Directory RID Manager$ object must be configured with proper audit settings. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000220'
  when:
      - wn22_dc_000220
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000220
      - V-254406
      - SRG-OS-000327-GPOS-00127
      - SV-254406r849034_rule
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN22-DC-000230 | PATCH | Windows Server 2022 must be configured to audit Account Management - Computer Account Management successes."
  block:
      - name: "MEDIUM | WN22-DC-000230 | AUDIT | Windows Server 2022 must be configured to audit Account Management - Computer Account Management successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Computer Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_dc_000230_audit

      - name: "MEDIUM | WN22-DC-000230 | PATCH | Windows Server 2022 must be configured to audit Account Management - Computer Account Management successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Computer Account Management" /success:enable
        when: "'Success' not in wn22_dc_000230_audit.stdout"
  when:
      - wn22_dc_000230
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000230
      - V-254407
      - SRG-OS-000004-GPOS-00004
      - SRG-OS-000239-GPOS-00089
      - SRG-OS-000240-GPOS-00090
      - SRG-OS-000241-GPOS-00091
      - SRG-OS-000303-GPOS-00120
      - SRG-OS-000476-GPOS-00221
      - SV-254407r849037_rule
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN22-DC-000240 | PATCH | Windows Server 2022 must be configured to audit DS Access - Directory Service Access successes."
  block:
      - name: "MEDIUM | WN22-DC-000240 | AUDIT | Windows Server 2022 must be configured to audit DS Access - Directory Service Access successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_dc_000240_audit

      - name: "MEDIUM | WN22-DC-000240 | PATCH | Windows Server 2022 must be configured to audit DS Access - Directory Service Access successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Access" /success:enable
        when: "'Success' not in wn22_dc_000240_audit.stdout"
  when:
      - wn22_dc_000240
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000240
      - V-254408
      - SRG-OS-000327-GPOS-00127
      - SRG-OS-000458-GPOS-00203
      - SRG-OS-000463-GPOS-00207
      - SRG-OS-000468-GPOS-00212
      - SV-254408r849040_rule
      - CCI-000172
      - CCI-002234
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000250 | PATCH | Windows Server 2022 must be configured to audit DS Access - Directory Service Access failures."
  block:
      - name: "MEDIUM | WN22-DC-000250 | AUDIT | Windows Server 2022 must be configured to audit DS Access - Directory Service Access failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_dc_000250_audit

      - name: "MEDIUM | WN22-DC-000250 | PATCH | Windows Server 2022 must be configured to audit DS Access - Directory Service Access failures."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Access" /failure:enable
        when: "'Failure' not in wn22_dc_000250_audit.stdout"
  when:
      - wn22_dc_000250
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000250
      - V-254409
      - SRG-OS-000327-GPOS-00127
      - SV-254409r849043_rule
      - SRG-OS-000458-GPOS-00203
      - SRG-OS-000463-GPOS-00207
      - SRG-OS-000468-GPOS-00212
      - CCI-000172
      - CCI-002234
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000260 | PATCH | Windows Server 2022 must be configured to audit DS Access - Directory Service Changes successes."
  block:
      - name: "MEDIUM | WN22-DC-000260 | AUDIT | Windows Server 2022 must be configured to audit DS Access - Directory Service Changes successes."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Changes" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_dc_000260_audit

      - name: "MEDIUM | WN22-DC-000260 | PATCH | Windows Server 2022 must be configured to audit DS Access - Directory Service Changes successes."
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Changes" /success:enable
        when: "'Success' not in wn22_dc_000260_audit.stdout"
  when:
      - wn22_dc_000260
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000260
      - V-254410
      - SRG-OS-000327-GPOS-00127
      - SRG-OS-000458-GPOS-00203
      - SRG-OS-000463-GPOS-00207
      - SRG-OS-000468-GPOS-00212
      - SV-254410r849046_rule
      - CCI-000172
      - CCI-002234
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000280 | AUDIT | Windows Server 2022 domain controllers must have a PKI server certificate."
  block:
      - name: "MEDIUM | WN22-DC-000280 | AUDIT | Windows Server 2022 domain controllers must have a PKI server certificate."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 domain controllers must have a PKI server certificate."

      - name: "MEDIUM | WN22-DC-000280 | AUDIT | Windows Server 2022 domain controllers must have a PKI server certificate. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000280'
  when:
      - wn22_dc_000280
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000280
      - V-254412
      - SRG-OS-000066-GPOS-00034
      - SV-254412r849052_rule
      - CCI-000185
      - CAT2

- name: "MEDIUM | WN22-DC-000310 | AUDIT | Windows Server 2022 Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."
  block:
      - name: "MEDIUM | WN22-DC-000310 | AUDIT | Windows Server 2022 Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."

      - name: "MEDIUM | WN22-DC-000310 | AUDIT | Windows Server 2022 Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000310'
  when:
      - wn22_dc_000310
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000310
      - V-254415
      - SRG-OS-000105-GPOS-00052
      - SRG-OS-000106-GPOS-00053
      - SRG-OS-000107-GPOS-00054
      - SRG-OS-000108-GPOS-00055
      - SRG-OS-000375-GPOS-00160
      - SV-254415r849355_rule
      - CCI-000765
      - CCI-000766
      - CCI-000767
      - CCI-000768
      - CCI-001948
      - CAT2

- name: "MEDIUM | WN22-DC-000320 | PATCH | Windows Server 2022 domain controllers must require LDAP access signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters
      value: LDAPServerIntegrity
      data: 2
      datatype: dword
  when:
      - wn22_dc_000320
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000320
      - V-254416
      - SRG-OS-000423-GPOS-00187
      - SRG-OS-000424-GPOS-00188
      - SV-254416r849064_rule
      - CCI-002418
      - CCI-002421
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000330 | PATCH | Windows Server 2022 domain controllers must be configured to allow reset of machine account passwords."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      value: RefusePasswordChange
      data: 0
      datatype: dword
  when:
      - wn22_dc_000330
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000330
      - V-254417
      - SRG-OS-000480-GPOS-00227
      - SV-254417r849067_rule
      - CCI-000366
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000340 | PATCH | Windows Server 2022 Access this computer from the network user right must only be assigned to the Administrators, Authenticated Users, and Enterprise Domain Controllers groups on domain controllers."
  ansible.windows.win_user_right:
      name: SeNetworkLogonRight
      users:
          - Administrators
          - Authenticated Users
          - Enterprise Domain Controllers
      action: set
  when:
      - wn22_dc_000340
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000340
      - V-254418
      - SRG-OS-000080-GPOS-00048
      - SV-254418r849070_rule
      - CCI-000213
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000350 | PATCH | Windows Server 2022 Add workstations to domain user right must only be assigned to the Administrators group on domain controllers."
  ansible.windows.win_user_right:
      name: SeMachineAccountPrivilege
      users: Administrators
      action: set
  when:
      - wn22_dc_000350
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000350
      - V-254419
      - SRG-OS-000324-GPOS-00125
      - SV-254419r877392_rule
      - CCI-002235
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000360 | PATCH | Windows Server 2022 Allow log on through Remote Desktop Services user right must only be assigned to the Administrators group on domain controllers."
  ansible.windows.win_user_right:
      name: SeRemoteInteractiveLogonRight
      users: Administrators
      action: set
  when:
      - wn22_dc_000360
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000360
      - V-254420
      - SRG-OS-000080-GPOS-00048
      - SV-254420r849076_rule
      - CCI-000213
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000370 | PATCH | Windows Server 2022 Deny access to this computer from the network user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyNetworkLogonRight
      users: Guests
      action: set
  when:
      - wn22_dc_000370
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000370
      - V-254421
      - SRG-OS-000080-GPOS-00048
      - SV-254421r849079_rule
      - CCI-000213
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000380 | PATCH | Windows Server 2022 Deny log on as a batch job user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyBatchLogonRight
      users: Guests
      action: set
  when:
      - wn22_dc_000380
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000380
      - V-254422
      - SRG-OS-000080-GPOS-00048
      - SV-254422r849082_rule
      - CCI-000213
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000390 | PATCH | Windows Server 2022 Deny log on as a service user right must be configured to include no accounts or groups (blank) on domain controllers."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeDenyServiceLogonRight
      value: ""
  when:
      - wn22_dc_000390
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000390
      - V-254423
      - SRG-OS-000080-GPOS-00048
      - SV-254423r849085_rule
      - CCI-000213
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000400 | PATCH | Windows Server 2022 Deny log on locally user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyInteractiveLogonRight
      users: Guests
      action: set
  when:
      - wn22_dc_000400
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000400
      - V-254424
      - SRG-OS-000080-GPOS-00048
      - SV-254424r849088_rule
      - CCI-000213
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000410 | PATCH | Windows Server 2022 Deny log on through Remote Desktop Services user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyRemoteInteractiveLogonRight
      users: Guests
      action: set
  when:
      - wn22_dc_000410
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000410
      - V-254425
      - SRG-OS-000297-GPOS-00115
      - SV-254425r849091_rule
      - CCI-002314
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000420 | PATCH | Windows Server 2022 Enable computer and user accounts to be trusted for delegation user right must only be assigned to the Administrators group on domain controllers."
  ansible.windows.win_user_right:
      name: SeEnableDelegationPrivilege
      users: Administrators
      action: set
  when:
      - wn22_dc_000420
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-DC-000420
      - V-254426
      - SRG-OS-000324-GPOS-00125
      - SV-254426r877392_rule
      - CCI-002235
      - CAT2
      - NeedToTestDomainController

- name: "MEDIUM | WN22-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days."
  block:
      - name: "MEDIUM | WN22-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days."
        ansible.windows.win_shell: "Get-ADUser krbtgt -Property PasswordLastSet | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn22stig_krbtgt_pass_age }}))} | Select-Object -ExpandProperty PasswordLastSet"
        changed_when: false
        failed_when: false
        check_mode: false
        register: wn22_dc_000430_audit

      - name: "MEDIUM | WN22-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. The password for the krbtgt account on a domain must be reset at least every 180 days."

      - name: "MEDIUM | WN22-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-DC-000430'
  when:
      - wn22_dc_000430
      - ansible_windows_domain_role == "Primary domain controller"
      - win2022stig_complexity_high
  tags:
      - WN22-DC-000430
      - V-254427
      - SRG-OS-000480-GPOS-00227
      - SV-254427r849097_rule
      - CCI-000366
      - NeedToTestDomainController
      - CAT2

- name: "MEDIUM | WN22-MS-000020 | PATCH | Windows Server 2022 local administrator accounts must have their privileged token filtered to prevent elevated privileges from being used over the network on domain systems."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: LocalAccountTokenFilterPolicy
      data: 0
      datatype: dword
  when:
      - wn22_ms_000020
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN22-MS-000020
      - V-254429
      - SRG-OS-000134-GPOS-00068
      - SV-254429r849103_rule
      - CCI-001084
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-MS-000030 | PATCH | Windows Server 2022 local users on domain-joined member servers must not be enumerated."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      value: EnumerateLocalUsers
      data: 0
      datatype: dword
  when:
      - wn22_ms_000030
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN22-MS-000030
      - V-254430
      - SRG-OS-000095-GPOS-00049
      - SV-254430r849106_rule
      - CCI-000381
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-MS-000040 | PATCH | Windows Server 2022 must restrict unauthenticated Remote Procedure Call (RPC) clients from connecting to the RPC server on domain-joined member servers and standalone or nondomain-joined systems."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc
      value: RestrictRemoteClients
      data: 1
      datatype: dword
  when:
      - wn22_ms_000040
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-MS-000040
      - V-254431
      - SRG-OS-000379-GPOS-00164
      - SV-254431r877039_rule
      - CCI-001967
      - CAT2

- name: "MEDIUM | WN22-MS-000050 | PATCH | Windows Server 2022 must limit the caching of logon credentials to four or less on domain-joined member servers."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
      value: CachedLogonsCount
      data: 4
      datatype: dword
  when:
      - wn22_ms_000050
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN22-MS-000050
      - V-254432
      - SRG-OS-000480-GPOS-00227
      - SV-254432r849112_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-MS-000060 | PATCH | Windows Server 2022 must restrict remote calls to the Security Account Manager (SAM) to Administrators on domain-joined member servers and standalone or nondomain-joined systems."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      value: RestrictRemoteSAM
      data: O:BAG:BAD:(A;;RC;;;BA)
      datatype: string
  when:
      - wn22_ms_000060
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-MS-000060
      - V-254433
      - SRG-OS-000324-GPOS-00125
      - SV-254433r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-MS-000070 | PATCH | Windows Server 2022 Access this computer from the network user right must only be assigned to the Administrators and Authenticated Users groups on domain-joined member servers and standalone systems."
  ansible.windows.win_user_right:
      name: SeNetworkLogonRight
      users:
          - Administrators
          - Authenticated Users
      action: set
  when:
      - wn22_ms_000070
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-MS-000070
      - V-254434
      - SRG-OS-000080-GPOS-00048
      - SV-254434r849118_rule
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN22-MS-000080 | PATCH | Windows Server 2022 Deny access to this computer from the network user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and local accounts and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN22-MS-000080 | PATCH | Windows Server 2022 Deny access to this computer from the network user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and local accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyNetworkLogonRight
            users:
                - Guests
                - Enterprise Admins
                - Domain Admins
                - Local account
                - Local account and member of Administrators group
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN22-MS-000080 | PATCH | Windows Server 2022 Deny access to this computer from the network user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and local accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyNetworkLogonRight
            users: Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn22_ms_000080
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-MS-000080
      - V-254435
      - SRG-OS-000080-GPOS-00048
      - SV-254435r849121_rule
      - CCI-000213
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-MS-000090 | PATCH | Windows Server 2022 Deny log on as a batch job user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN22-MS-000090 | PATCH | Windows Server 2022 Deny log on as a batch job user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users:
                - Enterprise Admins
                - Domain Admins
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN22-MS-000090 | PATCH | Windows Server 2022 Deny log on as a batch job user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users: Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn22_ms_000090
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN22-MS-000090
      - V-254436
      - SRG-OS-000080-GPOS-00048
      - SV-254436r849124_rule
      - CCI-000213
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-MS-000100 | PATCH | Windows Server 2022 Deny log on as a batch job user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN22-MS-000100 | PATCH | DOMAIN MEMBER | Windows Server 2022 Deny log on as a batch job user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users:
                - Enterprise Admins
                - Domain Admins
                - Guests
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN22-MS-000100 | PATCH | STAND-ALONE | Windows Server 2022 Deny log on as a batch job user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn22_ms_000100
  tags:
      - WN22-MS-000100
      - V-254437
      - SRG-OS-000080-GPOS-00048
      - SV-254437r890547_rule
      - CCI-000213
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-MS-000110 | PATCH | Windows Server 2022 Deny log on locally user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN22-MS-000110 | PATCH | DOMAIN MEMBER | Windows Server 2022 Deny log on locally user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyInteractiveLogonRight
            users:
                - Guests
                - Enterprise Admins
                - Domain Admins
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN22-MS-000110 | PATCH | STAND-ALONE | Windows Server 2022 Deny log on locally user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyInteractiveLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn22_ms_000110
  tags:
      - WN22-MS-000110
      - V-254438
      - SRG-OS-000080-GPOS-00048
      - SV-254438r849130_rule
      - CCI-000213
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-MS-000120 | PATCH | Windows Server 2022 Deny log on through Remote Desktop Services user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and all local accounts and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN22-MS-000120 | PATCH | DOMAIN MEMBER | Windows Server 2022 Deny log on through Remote Desktop Services user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and all local accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyRemoteInteractiveLogonRight
            users:
                - Guests
                - Local account
                - Enterprise Admins
                - Domain Admins
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN22-MS-000120 | PATCH | STAND-ALONE | Windows Server 2022 Deny log on through Remote Desktop Services user right on domain-joined member servers must be configured to prevent access from highly privileged domain accounts and all local accounts and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyRemoteInteractiveLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn22_ms_000120
  tags:
      - WN22-MS-000120
      - V-254439
      - SRG-OS-000297-GPOS-00115
      - SV-254439r849133_rule
      - CCI-002314
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-MS-000130 | PATCH | Windows Server 2022 Enable computer and user accounts to be trusted for delegation user right must not be assigned to any groups or accounts on domain-joined member servers and standalone or nondomain-joined systems."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeEnableDelegationPrivilege
      value: ""
  when:
      - wn22_ms_000130
  tags:
      - WN22-MS-000130
      - V-254440
      - SRG-OS-000324-GPOS-00125
      - SV-254440r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-PK-000010 | AUDIT | Windows Server 2022 must have the DoD Root Certificate Authority (CA) certificates installed in the Trusted Root Store."
  block:
      - name: "MEDIUM | WN22-PK-000010 | AUDIT | Windows Server 2022 must have the DoD Root Certificate Authority (CA) certificates installed in the Trusted Root Store."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\root | Where Subject -Like "*DoD*" | FL Subject, Thumbprint, NotAfter
        changed_when: false
        check_mode: false
        register: wn22_PK_000010_audit

      - name: "MEDIUM | WN22-PK-000010 | AUDIT | Windows Server 2022 must have the DoD Root Certificate Authority (CA) certificates installed in the Trusted Root Store."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have the DoD Root Certificate Authority (CA) certificates installed in the Trusted Root Store."

      - name: "MEDIUM | WN22-PK-000010 | AUDIT | Windows Server 2022 must have the DoD Root Certificate Authority (CA) certificates installed in the Trusted Root Store. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-PK-000010'
  when:
      - wn22_pk_000010
  tags:
      - WN22-PK-000010
      - V-254442
      - SRG-OS-000066-GPOS-00034
      - SV-254442r894653_rule
      - CCI-000185
      - CCI-002470
      - CAT2

- name: "MEDIUM | WN22-PK-000020 | AUDIT | Windows Server 2022 must have the DoD Interoperability Root Certificate Authority (CA) cross-certificates installed in the Untrusted Certificates Store on unclassified systems."
  block:
      - name: "MEDIUM | WN22-PK-000020 | AUDIT | Windows Server 2022 must have the DoD Interoperability Root Certificate Authority (CA) cross-certificates installed in the Untrusted Certificates Store on unclassified systems."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\disallowed | Where {$_.Issuer -Like "*DoD Interoperability*" -and $_.Subject -Like "*DoD*"} | FL Subject, Issuer, Thumbprint, NotAfter
        changed_when: false
        check_mode: false
        register: wn22_pk_000020_audit

      - name: "MEDIUM | WN22-PK-000020 | AUDIT | Windows Server 2022 must have the DoD Interoperability Root Certificate Authority (CA) cross-certificates installed in the Untrusted Certificates Store on unclassified systems."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have the DoD Interoperability Root Certificate Authority (CA) cross-certificates installed in the Untrusted Certificates Store on unclassified systems."

      - name: "MEDIUM | WN22-PK-000020 | AUDIT | Windows Server 2022 must have the DoD Interoperability Root Certificate Authority (CA) cross-certificates installed in the Untrusted Certificates Store on unclassified systems. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-PK-000020'
  when:
      - wn22_pk_000020
  tags:
      - WN22-PK-000020
      - V-254443
      - SRG-OS-000066-GPOS-00034
      - SV-254443r890553_rule
      - CCI-000185
      - CCI-002470
      - CAT2

- name: "MEDIUM | WN22-PK-000030 | AUDIT | Windows Server 2022 must have the US DoD CCEB Interoperability Root CA cross-certificates in the Untrusted Certificates Store on unclassified systems."
  block:
      - name: "MEDIUM | WN22-PK-000030 | AUDIT | Windows Server 2022 must have the US DoD CCEB Interoperability Root CA cross-certificates in the Untrusted Certificates Store on unclassified systems."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\disallowed | Where Issuer -Like "*CCEB Interoperability*" | FL Subject, Issuer, Thumbprint, NotAfter
        changed_when: false
        check_mode: false
        register: wn22_pk_000030_audit

      - name: "MEDIUM | WN22-PK-000030 | AUDIT | Windows Server 2022 must have the US DoD CCEB Interoperability Root CA cross-certificates in the Untrusted Certificates Store on unclassified systems."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2022 must have the US DoD CCEB Interoperability Root CA cross-certificates in the Untrusted Certificates Store on unclassified systems."

      - name: "MEDIUM | WN22-PK-000030 | AUDIT | Windows Server 2022 must have the US DoD CCEB Interoperability Root CA cross-certificates in the Untrusted Certificates Store on unclassified systems. | import reuseable task."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-PK-000030'
  when:
      - wn22_pk_000030
  tags:
      - WN22-PK-000030
      - V-254444
      - SRG-OS-000066-GPOS-00034
      - SV-254444r894343_rule
      - CCI-000185
      - CCI-002470
      - CAT2

- name: "MEDIUM | WN22-SO-000010 | PATCH | Windows Server 2022 must have the built-in guest account disabled."
  community.windows.win_security_policy:
      section: System Access
      key: EnableGuestAccount
      value: 0
  when:
      - wn22_so_000010
  tags:
      - WN22-SO-000010
      - V-254445
      - SRG-OS-000121-GPOS-00062
      - SV-254445r849151_rule
      - CCI-000804
      - CAT2

- name: "MEDIUM | WN22-SO-000030 | PATCH | Windows Server 2022 built-in administrator account must be renamed."
  block:
      - name: "MEDIUM | WN22-SO-000030 | AUDIT | Windows Server 2022 built-in administrator account must be renamed. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have not changed the default name for wn22stig_newadministratorname, please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - "'adminchangethis' in wn22stig_newadministratorname"

      - name: "MEDIUM | WN22-SO-000030 | AUDIT | Windows Server 2022 built-in administrator account must be renamed. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-SO-000030'
        when:
            - "'adminchangethis' in wn22stig_newadministratorname"

      - name: "MEDIUM | WN22-SO-000030 | PATCH | Windows Server 2022 built-in administrator account must be renamed. | Set Variable."
        community.windows.win_security_policy:
            section: System Access
            key: NewAdministratorName
            value: "{{ wn22stig_newadministratorname }}"
        when:
            - "'adminchangethis' not in wn22stig_newadministratorname"
  when:
      - wn22_so_000030
  tags:
      - WN22-SO-000030
      - V-254447
      - SRG-OS-000480-GPOS-00227
      - SV-254447r849157_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000040 | PATCH | Windows Server 2022 built-in guest account must be renamed."
  block:
      - name: "MEDIUM | WN22-SO-000040 | AUDIT | Windows Server 2022 built-in guest account must be renamed. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have not changed the default name for wn22stig_newguestname, please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - "'guestchangethis' in wn22stig_newguestname"

      - name: "MEDIUM | WN22-SO-000040 | AUDIT | Windows Server 2022 built-in guest account must be renamed. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN22-SO-000040'
        when:
            - "'guestchangethis' in wn22stig_newguestname"

      - name: "MEDIUM | WN22-SO-000040 | PATCH | Windows Server 2022 built-in guest account must be renamed. | Set Variable."
        community.windows.win_security_policy:
            section: System Access
            key: NewGuestName
            value: "{{ wn22stig_newguestname }}"
        when:
            - "'guestchangethis' not in wn22stig_newguestname"
  when:
      - wn22_so_000040
  tags:
      - WN22-SO-000040
      - V-254448
      - SRG-OS-000480-GPOS-00227
      - SV-254448r849160_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000050 | PATCH | Windows Server 2022 must force audit policy subcategory settings to override audit policy category settings."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\
      value: SCENoApplyLegacyAuditPolicy
      data: 1
      datatype: dword
  when:
      - wn22_so_000050
  tags:
      - WN22-SO-000050
      - V-254449
      - SRG-OS-000062-GPOS-00031
      - SV-254449r849163_rule
      - CCI-000169
      - CAT2

- name: "MEDIUM | WN22-SO-000060 | PATCH | Windows Server 2022 setting Domain member: Digitally encrypt or sign secure channel data (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      value: RequireSignOrSeal
      data: 1
      datatype: dword
  when:
      - wn22_so_000060
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN22-SO-000060
      - V-254450
      - SRG-OS-000423-GPOS-00187
      - SRG-OS-000424-GPOS-00188
      - SV-254450r849166_rule
      - CCI-002418
      - CCI-002421
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-SO-000070 | PATCH | Windows Server 2022 setting Domain member: Digitally encrypt secure channel data (when possible) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      value: SignSecureChannel
      data: 1
      datatype: dword
  when:
      - wn22_so_000070
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN22-SO-000070
      - V-254451
      - SRG-OS-000423-GPOS-00187
      - SRG-OS-000424-GPOS-00188
      - SV-254451r849169_rule
      - CCI-002418
      - CCI-002421
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-SO-000080 | PATCH | Windows Server 2022 setting Domain member: Digitally sign secure channel data (when possible) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      value: SignSecureChannel
      data: 1
      datatype: dword
  when:
      - wn22_so_000080
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN22-SO-000080
      - V-254452
      - SRG-OS-000423-GPOS-00187
      - SRG-OS-000424-GPOS-00188
      - SV-254452r849172_rule
      - CCI-002418
      - CCI-002421
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-SO-000090 | PATCH | Windows Server 2022 computer account password must not be prevented from being reset."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      value: DisablePasswordChange
      data: 0
      datatype: dword
  when:
      - wn22_so_000090
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN22-SO-000090
      - V-254453
      - SRG-OS-000379-GPOS-00164
      - SV-254453r877039_rule
      - CCI-001967
      - CAT2
      - NeedToTestMemberServer

- name: "MEDIUM | WN22-SO-000100 | PATCH | Windows Server 2022 maximum age for machine account passwords must be configured to 30 days or less."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      value: MaximumPasswordAge
      data: 30
      datatype: dword
  when:
      - wn22_so_000100
  tags:
      - WN22-SO-000100
      - V-254454
      - SRG-OS-000480-GPOS-00227
      - SV-254454r849178_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000110 | PATCH | Windows Server 2022 must be configured to require a strong session key."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      value: RequireStrongKey
      data: 1
      datatype: dword
  when:
      - wn22_so_000110
  tags:
      - WN22-SO-000110
      - V-254455
      - SRG-OS-000423-GPOS-00187
      - SV-254455r849181_rule
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN22-SO-000120 | PATCH | Windows Server 2022 machine inactivity limit must be set to 15 minutes or less, locking the system with the screen saver."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: InactivityTimeoutSecs
      data: 900
      datatype: dword
  when:
      - wn22_so_000120
  tags:
      - WN22-SO-000120
      - V-254456
      - SRG-OS-000028-GPOS-00009
      - SV-254456r849184_rule
      - CCI-000056
      - CCI-000057
      - CCI-000060
      - CAT2

- name: "MEDIUM | WN22-SO-000130 | PATCH | Windows Server 2022 required legal notice must be configured to display before console logon."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: LegalNoticeText
      data: "{{ wn22stig_legalnoticetext }}"
      datatype: string
  when:
      - wn22_so_000130
  tags:
      - WN22-SO-000130
      - V-254457
      - SRG-OS-000023-GPOS-00006
      - SV-254457r849187_rule
      - CCI-000048
      - CCI-000050
      - CCI-001384
      - CCI-001385
      - CCI-001386
      - CCI-001387
      - CCI-001388
      - CAT2

- name: "MEDIUM | WN22-SO-000150 | PATCH | Windows Server 2022 Smart Card removal option must be configured to Force Logoff or Lock Workstation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
      value: scremoveoption
      data: 1
      datatype: string
  when:
      - wn22_so_000150
  tags:
      - WN22-SO-000150
      - V-254459
      - SRG-OS-000480-GPOS-00227
      - SV-254459r849193_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000160 | PATCH | Windows Server 2022 etting Microsoft network client: Digitally sign communications (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      value: RequireSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn22_so_000160
  tags:
      - WN22-SO-000160
      - V-254460
      - SRG-OS-000423-GPOS-00187
      - SRG-OS-000424-GPOS-00188
      - SV-254460r849196_rule
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN22-SO-000170 | PATCH | Windows Server 2022 setting Microsoft network client: Digitally sign communications (if server agrees) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn22_so_000170
  tags:
      - WN22-SO-000170
      - V-254461
      - SRG-OS-000423-GPOS-00187
      - SRG-OS-000424-GPOS-00188
      - SV-254461r849199_rule
      - CCI-002421
      - CCI-002418
      - CAT2

- name: "MEDIUM | WN22-SO-000180 | PATCH | Windows Server 2022 unencrypted passwords must not be sent to third-party Server Message Block (SMB) servers."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  when:
      - wn22_so_000180
  tags:
      - WN22-SO-000180
      - V-254462
      - SRG-OS-000074-GPOS-00042
      - SV-254462r877396_rule
      - CCI-000197
      - CAT2

- name: "MEDIUM | WN22-SO-000190 | PATCH | Windows Server 2022 setting Microsoft network server: Digitally sign communications (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters
      value: RequireSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn22_so_000190
  tags:
      - WN22-SO-000190
      - V-254463
      - SRG-OS-000423-GPOS-00187
      - SV-254463r849205_rule
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN22-SO-000200 | PATCH | Windows Server 2022 setting Microsoft network server: Digitally sign communications (if client agrees) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn22_so_000200
  tags:
      - WN22-SO-000200
      - V-254464
      - SRG-OS-000423-GPOS-00187
      - SV-254464r849208_rule
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN22-SO-000240 | PATCH | Windows Server 2022 must be configured to prevent anonymous users from having the same permissions as the Everyone group."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  when:
      - wn22_so_000240
  tags:
      - WN22-SO-000240
      - V-254468
      - SRG-OS-000480-GPOS-00227
      - SV-254468r849220_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000260 | PATCH | Windows Server 2022 services using Local System that use Negotiate when reverting to NTLM authentication must use the computer identity instead of authenticating anonymously."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      value: UseMachineId
      data: 1
      datatype: dword
  when:
      - wn22_so_000260
  tags:
      - WN22-SO-000260
      - V-254470
      - SRG-OS-000480-GPOS-00227
      - SV-254470r849226_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000270 | PATCH | Windows Server 2022 must prevent NTLM from falling back to a Null session."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      value: allownullsessionfallback
      data: 0
      datatype: dword
  when:
      - wn22_so_000270
  tags:
      - WN22-SO-000270
      - V-254471
      - SRG-OS-000480-GPOS-00227
      - SV-254471r849229_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000280 | PATCH | Windows Server 2022 Must prevent PKU2U authentication using online identities."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\pku2u
      value: AllowOnlineID
      data: 0
      datatype: dword
  when:
      - wn22_so_000280
  tags:
      - WN22-SO-000280
      - V-254472
      - SRG-OS-000480-GPOS-00227
      - SV-254472r849232_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000290 | PATCH | Windows Server 2022 Kerberos encryption types must be configured to prevent the use of DES and RC4 encryption suites."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters
      value: SupportedEncryptionTypes
      data: 2147483640
      datatype: dword
  when:
      - wn22_so_000290
  tags:
      - WN22-SO-000290
      - V-254473
      - SRG-OS-000120-GPOS-00061
      - SV-254473r849235_rule
      - CCI-000803
      - CAT2

- name: "MEDIUM | WN22-SO-000320 | PATCH | Windows Server 2022 must be configured to at least negotiate signing for LDAP client signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LDAP
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  when:
      - wn22_so_000320
  tags:
      - WN22-SO-000320
      - V-254476
      - SRG-OS-000480-GPOS-00227
      - SV-254476r849244_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000330 | PATCH | Windows Server 2022 session security for NTLM SSP-based clients must be configured to require NTLMv2 session security and 128-bit encryption."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      value: NTLMMinClientSec
      data: 537395200
      datatype: dword
  when:
      - wn22_so_000330
  tags:
      - WN22-SO-000330
      - V-254477
      - SRG-OS-000480-GPOS-00227
      - SV-254477r849247_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000340 | PATCH | Windows Server 2022 session security for NTLM SSP-based servers must be configured to require NTLMv2 session security and 128-bit encryption."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      value: NTLMMinServerSec
      data: 537395200
      datatype: dword
  when:
      - wn22_so_000340
  tags:
      - WN22-SO-000340
      - V-254478
      - SRG-OS-000480-GPOS-00227
      - SV-254478r849250_rule
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN22-SO-000350 | PATCH | Windows Server 2022 users must be required to enter a password to access private keys stored on the computer."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Cryptography
      value: ForceKeyProtection
      data: 2
      datatype: dword
  when:
      - wn22_so_000350
  tags:
      - WN22-SO-000350
      - V-254479
      - SRG-OS-000067-GPOS-00035
      - SV-254479r849253_rule
      - CCI-000186
      - CAT2

- name: "MEDIUM | WN22-SO-000360 | PATCH | Windows Server 2022 must be configured to use FIPS-compliant algorithms for encryption, hashing, and signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager
      value: ProtectionMode
      data: 1
      datatype: dword
  when:
      - wn22_so_000360
  tags:
      - WN22-SO-000360
      - V-254480
      - SRG-OS-000478-GPOS-00223
      - SV-254480r877466_rule
      - CCI-002450
      - CAT2

- name: "MEDIUM | WN22-SO-000380 | PATCH | Windows Server 2022 User Account Control approval mode for the built-in Administrator must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: FilterAdministratorToken
      data: 1
      datatype: dword
  when:
      - wn22_so_000380
  tags:
      - WN22-SO-000380
      - V-254482
      - SRG-OS-000373-GPOS-00156
      - SV-254482r849262_rule
      - CCI-002038
      - CAT2
      # - exclusions for server core? think its NA there

- name: "MEDIUM | WN22-SO-000390 | PATCH | Windows Server 2022 UIAccess applications must not be allowed to prompt for elevation without using the secure desktop."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: EnableUIADesktopToggle
      data: 0
      datatype: dword
  when:
      - wn22_so_000390
  tags:
      - WN22-SO-000390
      - V-254483
      - SRG-OS-000134-GPOS-00068
      - SV-254483r849265_rule
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN22-SO-000400 | PATCH | Windows Server 2022 User Account Control must, at a minimum, prompt administrators for consent on the secure desktop."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: ConsentPromptBehaviorAdmin
      data: 2
      datatype: dword
  when:
      - wn22_so_000400
  tags:
      - WN22-SO-000400
      - V-254484
      - SRG-OS-000134-GPOS-00068
      - SV-254484r849268_rule
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN22-SO-000410 | PATCH | Windows Server 2022 User Account Control must automatically deny standard user requests for elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: ConsentPromptBehaviorUser
      data: 0
      datatype: dword
  when:
      - wn22_so_000410
  tags:
      - WN22-SO-000410
      - V-254485
      - SRG-OS-000373-GPOS-00157
      - SRG-OS-000373-GPOS-00156
      - SV-254485r849271_rule
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN22-SO-000420 | PATCH | Windows Server 2022 User Account Control must be configured to detect application installations and prompt for elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: EnableInstallerDetection
      data: 1
      datatype: dword
  when:
      - wn22_so_000420
  tags:
      - WN22-SO-000420
      - V-254486
      - SRG-OS-000134-GPOS-00068
      - SV-254486r849274_rule
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN22-SO-000430 | PATCH | Windows Server 2022 User Account Control (UAC) must only elevate UIAccess applications that are installed in secure locations."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: EnableSecureUIAPaths
      data: 1
      datatype: dword
  when:
      - wn22_so_000430
  tags:
      - WN22-SO-000430
      - V-254487
      - SRG-OS-000134-GPOS-00068
      - SV-254487r849277_rule
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN22-SO-000440 | PATCH | Windows Server 2022 User Account Control must run all administrators in Admin Approval Mode, enabling UAC."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: EnableLUA
      data: 1
      datatype: dword
  when:
      - wn22_so_000440
  tags:
      - WN22-SO-000440
      - V-254488
      - SRG-OS-000373-GPOS-00157
      - SRG-OS-000373-GPOS-00156
      - SV-254488r849280_rule
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN22-SO-000450 | PATCH | Windows Server 2022 User Account Control (UAC) must virtualize file and registry write failures to per-user locations."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      value: EnableVirtualization
      data: 1
      datatype: dword
  when:
      - wn22_so_000450
  tags:
      - WN22-SO-000450
      - V-254489
      - SRG-OS-000134-GPOS-00068
      - SV-254489r849283_rule
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN22-UC-000010 | PATCH | Windows Server 2022 must preserve zone information when saving attachments."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Attachments
      value: SaveZoneInformation
      data: 2
      datatype: dword
  when:
      - wn22_uc_000010
  tags:
      - WN22-UC-000010
      - V-254490
      - SRG-OS-000480-GPOS-00227
      - SV-254490r849286_rule
      - CCI-000366
      - CAT2

# [WARNING]: Using this module to edit rights and privileges is error-prone, use the win_user_right module instead
- name: "MEDIUM | WN22-UR-000010 | PATCH | Windows Server 2022 Access Credential Manager as a trusted caller user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeTrustedCredManAccessPrivilege
      value: ""
  when:
      - wn22_ur_000010
  tags:
      - WN22-UR-000010
      - V-254491
      - SRG-OS-000324-GPOS-00125
      - SV-254491r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000030 | PATCH | Windows Server 2022 Allow log on locally user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeInteractiveLogonRight
      users: Administrators
      action: set
  when:
      - wn22_ur_000030
  tags:
      - WN22-UR-000030
      - V-254493
      - SRG-OS-000080-GPOS-00048
      - SV-254493r849295_rule
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN22-UR-000040 | PATCH | Windows Server 2022 Back up files and directories user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeBackupPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000040
  tags:
      - WN22-UR-000040
      - V-254494
      - SRG-OS-000324-GPOS-00125
      - SV-254494r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000050 | PATCH | Windows Server 2022 Create a pagefile user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeCreatePagefilePrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000050
  tags:
      - WN22-UR-000050
      - V-254495
      - SRG-OS-000324-GPOS-00125
      - SV-254495r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000070 | PATCH |  Windows Server 2022 Create global objects user right must only be assigned to Administrators, Service, Local Service, and Network Service."
  ansible.windows.win_user_right:
      name: SeCreateGlobalPrivilege
      users:
          - Administrators
          - Service
          - "Local Service"
          - Network Service
      action: set
  when:
      - wn22_ur_000070
  tags:
      - WN22-UR-000070
      - V-254497
      - SRG-OS-000324-GPOS-00125
      - SV-254497r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000080 | PATCH | Windows Server 2022 Create permanent shared objects user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeCreatePermanentPrivilege
      value: ""
  when:
      - wn22_ur_000080
  tags:
      - WN22-UR-000080
      - V-254498
      - SRG-OS-000324-GPOS-00125
      - SV-254498r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000090 | PATCH | Windows Server 2022 Create symbolic links user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeCreateSymbolicLinkPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000090
  tags:
      - WN22-UR-000090
      - V-254499
      - SRG-OS-000324-GPOS-00125
      - SV-254499r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000110 | PATCH | Windows Server 2022 Force shutdown from a remote system user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRemoteShutdownPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000110
  tags:
      - WN22-UR-000110
      - V-254501
      - SRG-OS-000324-GPOS-00125
      - SV-254501r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000120 | PATCH | Windows Server 2022 Generate security audits user right must only be assigned to Local Service and Network Service."
  ansible.windows.win_user_right:
      name: SeAuditPrivilege
      users:
          - Local Service
          - Network Service
      action: set
  when:
      - wn22_ur_000120
  tags:
      - WN22-UR-000120
      - V-254502
      - SRG-OS-000324-GPOS-00125
      - SV-254502r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000130 | PATCH | Windows Server 2022 Impersonate a client after authentication user right must only be assigned to Administrators, Service, Local Service, and Network Service."
  ansible.windows.win_user_right:
      name: SeImpersonatePrivilege
      users:
          - Administrators
          - Service
          - Local Service
          - Network Service
      action: set
  when:
      - wn22_ur_000130
  tags:
      - WN22-UR-000130
      - V-254503
      - SRG-OS-000324-GPOS-00125
      - SV-254503r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000140 | PATCH | Windows Server 2022 Increase scheduling priority: user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeIncreaseBasePriorityPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000140
  tags:
      - WN22-UR-000140
      - V-254504
      - SRG-OS-000324-GPOS-00125
      - SV-254504r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000150 | PATCH | Windows Server 2022 Load and unload device drivers user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeLoadDriverPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000150
  tags:
      - WN22-UR-000150
      - V-254505
      - SRG-OS-000324-GPOS-00125
      - SV-254505r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000160 | PATCH | Windows Server 2022 Lock pages in memory user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeLockMemoryPrivilege
      value: ""
  when:
      - wn22_ur_000160
  tags:
      - WN22-UR-000160
      - V-254506
      - SRG-OS-000324-GPOS-00125
      - SV-254506r877392_rule
      - CCI-002235
      - CCI-002824
      - CAT2

- name: "MEDIUM | WN22-UR-000170 | PATCH | Windows Server 2022 Manage auditing and security log user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeSecurityPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000170
  tags:
      - WN22-UR-000170
      - V-254507
      - SRG-OS-000057-GPOS-00027
      - SV-254507r849337_rule
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CCI-000171
      - CCI-001914
      - CAT2

- name: "MEDIUM | WN22-UR-000180 | PATCH | Windows Server 2022 Modify firmware environment values user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeSystemEnvironmentPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000180
  tags:
      - WN22-UR-000180
      - V-254508
      - SRG-OS-000324-GPOS-00125
      - SV-254508r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000190 | PATCH | Windows Server 2022 Perform volume maintenance tasks user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeManageVolumePrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000190
  tags:
      - WN22-UR-000190
      - V-254509
      - SRG-OS-000324-GPOS-00125
      - SV-254509r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000200 | PATCH | Windows Server 2022 Profile single process user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeProfileSingleProcessPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000200
  tags:
      - WN22-UR-000200
      - V-254510
      - SRG-OS-000324-GPOS-00125
      - SV-254510r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000210 | PATCH | Windows Server 2022 Restore files and directories user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRestorePrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000210
  tags:
      - WN22-UR-000210
      - V-254511
      - SRG-OS-000324-GPOS-00125
      - SV-254511r877392_rule
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN22-UR-000220 | PATCH | Windows Server 2022 Take ownership of files or other objects user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeTakeOwnershipPrivilege
      users: Administrators
      action: set
  when:
      - wn22_ur_000220
  tags:
      - WN22-UR-000220
      - V-254512
      - SRG-OS-000324-GPOS-00125
      - SV-254512r877392_rule
      - CCI-002235
      - CAT2
